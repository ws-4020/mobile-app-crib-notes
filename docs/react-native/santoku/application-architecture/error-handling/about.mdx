---
title: 基本的な考え方
---

モバイルアプリケーションでは、エラーが発生した場合にユーザへエラーの内容と、どのような手順で操作をすればエラーから回復できるかを伝える事が非常に重要です。

エラーは様々な場面で発生する可能性があります。React Nativeを利用したモバイルアプリケーションではそれらを網羅的にハンドリングするような仕組みを構築することは困難であり、機能やユーザ操作に応じて個別に設計する必要があります。

ここではエラーの処理方法に関する基本方針を定義します。

<!-- textlint-disable ja-technical-writing/sentence-length -->

:::note
Reactにはコンポーネント内で発生したエラーをハンドリングできる[Error Boundary](https://ja.reactjs.org/docs/error-boundaries.html)というコンポーネントがありますが、これはイベントハンドラや非同期処理で発生したエラーをハンドリングできません。
:::

<!-- textlint-enable ja-technical-writing/sentence-length -->

## エラーの処理方法に関する方針

エラーが発生する箇所は大きく以下のように分類できます。

- Reactコンポーネント
- イベントハンドラ
  - 非同期処理
  - 同期処理
- ロジック
  - 非同期処理
  - 同期処理
- Native Modules

### Reactコンポーネントのエラー処理

Reactコンポーネントのレンダリングでエラーが発生した場合は、`Error Boundary`でエラーを捕捉します。全てのレンダリングエラーを捕捉できるように、`Error Boundary`はコンポーネントツリーの最上部に定義します。

> 🚧 作成中 🚧

<!--
TODO: Error Boundaryを用いたコードを追記。
      FallbackComponentの引数として受け取るresetErrorBoundaryを使用して、Error Boundaryを含めたコンポーネントツリーを再レンダリングする記載を追記
-->

個別にReactコンポーネントから発生したエラーをハンドリングしたい場合は、該当のコンポーネントを`Error Boundary`でラップしてエラー処理を実施してください。

### イベントハンドラのエラー処理

イベントハンドラでエラーが発生した場合は、個別にエラーをハンドリングしない限りアプリケーションがクラッシュします。

> 🚧 作業中 🚧

<!--
TODO: ErrorUtilsを使用すれば、同期処理のエラーはハンドリングできる可能性があるので、検証後必要に応じて追記。
      ハンドリングできる可能性があると思ったのは、react-native-exception-handlerがErrorUtilsを使用してハンドリングしているから。
      https://github.com/a7ul/react-native-exception-handler/blob/master/index.js#L15
      ErrorUtilsでエラーを捕捉できた場合、react-native-restartとかを利用してアプリを再起動できるか検証必要。
-->

:::caution
アプリケーションのクラッシュは、ユーザのアプリケーション離脱率が高くなる一因になります。イベントハンドラ内で発生するエラーは個別にハンドリングして、アプリケーションのクラッシュを防ぐようにしてください。
:::

イベントハンドラ内で発生するエラーを個別にハンドリングする場合、非同期処理と同期処理で対応が変わります。

非同期処理は、以下のいづれかの方法でエラーを捕捉できます。

- `Promise.catch()`を使用してエラーを捕捉します。
- `await`式を利用した場合は`try...catch`文で囲んでエラーを捕捉します。

同期処理は、`try...catch`文で囲んでエラーを捕捉します。

### ロジックのエラー処理

イベントハンドラ以外のロジックでエラーが発生した場合は、非同期処理と同期処理で動作が違います。

非同期処理の場合は、イベントハンドラと同様で個別にエラーをハンドリングしない限りアプリケーションがクラッシュします。同期処理の場合は、Reactコンポーネントと同様に`Error Boundary`でエラーを捕捉します。

:::caution
アプリケーションのクラッシュは、ユーザのアプリケーション離脱率が高くなる一因になります。ロジック内で発生するエラーは個別にハンドリングして、アプリケーションのクラッシュを防ぐようにしてください。
:::

個別にロジック内で発生したエラーをハンドリングしたい場合は、イベントハンドラの非同期処理・同期処理と同様に`Promise.catch()`、または`try...catch`を利用してエラーを捕捉してください。

### Native Modulesのエラー処理

Native ModulesはJava(Kotlin)やObjective-C(Swift)、C++などのネイティブ言語を使用したモジュールです。OSが提供しているAPIなどを利用する時に作成します。

<!-- textlint-disable ja-technical-writing/sentence-length -->

Native Modulesでエラーが発生した場合は、Androidでは`Thread.setDefaultUncaughtExceptionHandler`、iOSでは`NSSetUncaughtExceptionHandler`を使用してエラーを捕捉します。捕捉したエラーの詳細は[Firebase Crashlytics](https://firebase.google.com/docs/crashlytics?hl=ja)に送ります。

<!-- textlint-enable ja-technical-writing/sentence-length -->

Firebase Crashlyticsにエラー情報を送信後、Androidではアプリケーションを再起動します。iOSではエラー発生時にアプリケーションを再起動する手段がないため、ユーザにアプリケーションの再起動を促すUIを表示します。

> 🚧 作業中 🚧

<!--
TODO: `Thread.setDefaultUncaughtExceptionHandler`や`NSSetUncaughtExceptionHandler`を使用してハンドリングできるか検証必要。
      react-native-exception-handlerのREADMEには、Androidでは再起動できてiOSではできないと記載されているが、自分たちでも検証必要。
      https://github.com/a7ul/react-native-exception-handler
      アプリケーションの再起動については、react-native-restartなどの動作も含めて、別ページで詳細に説明したほうが良いかも。
-->

<!-- textlint-disable ja-technical-writing/sentence-length -->

:::note
全てのエラーを捕捉すると、アプリケーションのクラッシュは防げますが、本来App Store Connect/Google Play Consoleに送られるはずのクラッシュデータは送信されません。
そのため、SantokuAppではFirebase Crashlyticsにエラーログを送信することで、アプリケーションのエラーを検知しています。

Firebase Crashlyticsや[Sentry](https://sentry.io/welcome/)のようなログを管理するプロダクトを利用できない場合は、エラーを捕捉せずにOSの機能を利用してアプリケーションのクラッシュデータをApp Store ConnectやGoogle Play Consoleに送信するのも1つの手段ではあります。

ただしアプリケーションがクラッシュすると、App StoreやGoogle Playでのアプリケーション検索時にヒット率が下がる可能性はあります。また、App Store ConnectやGoogle Play Consoleにクラッシュデータを送信するかはユーザに委ねられているため送信されない可能性もあります。送信された場合もクラッシュデータの詳細な内容は閲覧できません。

そのため、基本的には全てのエラーを捕捉してFirebase CrashlyticsやSentryのようなプロダクトに送信することが望ましいです。
:::

<!-- textlint-enable ja-technical-writing/sentence-length -->

Native Modulesで発生したエラーを個別にハンドリングをしたい場合は、言語毎のエラー処理方式に従ってエラーを捕捉してください。

> 🚧 作業中 🚧

<!--
TODO: 言語毎のエラー処理方式を記載
-->

また、Native Modulesで発生したエラーをJavaScript側に伝えたい場面もあります。その場合は、JavaScript側からエラー時に実行したいコールバック関数を受け取るか、Native ModulesからPromiseを返却する方法があります。詳細は、React Nativeのドキュメントを参照してください。

- [Android - Callbacks](https://reactnative.dev/docs/native-modules-android#callbacks)
- [Android - Promises](https://reactnative.dev/docs/native-modules-android#promises)
- [iOS - Callbacks](https://reactnative.dev/docs/native-modules-ios#callbacks)
- [iOS - Promises](https://reactnative.dev/docs/native-modules-ios#promises)
