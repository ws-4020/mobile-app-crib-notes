---
title: ユーザー操作への応答
---

ToDo一覧が表示されたらToDoのチェックボックスをタップして完了状態が更新されるまでの応答速度を改善してみましょう。

現状、ToDoのチェックボックスをタップしてもすぐに変更されず、応答が返ってくるまでユーザは待つ必要があります。
ToDo一覧の最新化と同じように処理が終わるまで操作をブロックしても良いですが、連続してToDoの完了状態を変更するときに、かなりのストレスになります。

ここではToDoのチェックボックスがタップされたタイミングで、サーバの応答を待たずにUIへ反映するようにしましょう。

## ToDoのチェックボックスをタップしたタイミングで更新

次のように対象のToDoの完了状態を変更して`setTodos`でstateを更新した後にREST APIを呼びだすように修正します。

すでにUIへ反映しているので、REST API呼び出し後のUI反映は不要です。

例えば、ToDoをタップして完了にしたとします。

その後にREST APIの応答を待たずに同じToDoをタップして未完了へ更新します。

本来は対象のToDoが`未完了`になってUIへ反映されることを期待しているのに`完了`へ間違った反映が発生します。

そのような事故を防止するために`then`の部分を削除します。

```diff typescript title="/src/screens/todo/TodoBoard.tsx"
export const TodoBoard: React.FC = () => {

    // 中略

    const toggleTodoCompletion = (id: number) => {

        const target = todos.find((todo) => todo.id === id);
        if (!target) {
            return;
        }
+       const updateTodo = {...target, completed: !target.completed};
+       setTodos((prevTodos) => prevTodos.map((todo) => (todo.id === id ? updateTodo : todo)));
        TodoService.putTodo(id, !target.completed)
-           .then((returnedTodo) =>
-               setTodos((prevTodos) => {
-                   return prevTodos.map((todo) => (todo.id === id ? returnedTodo : todo));
-               }),
-           )
            .catch(() => {});
    );

    // 中略

```

:::note
REST APIで正常に処理出来なかった場合、実際には完了状態の更新に失敗しているのにToDo一覧上は更新されているという状態になってしまいます。

このような不整合を防ぐためにはエラーが起きたときにもToDo一覧を更新する必要があります。

たとえば、エラーが起きたときは「ユーザにエラーを伝え」「ToDo一覧を最新化する」という方法が考えられます。

ここでは具体的な実装は紹介しないので、どのように実装できるかぜひ考えてみてください。
:::

## 動作確認

これでToDoのチェックボックスをタップしたタイミングですぐにUIへ反映されるようになりました。

実際にアプリを次の手順で動かして、確認していきましょう。

1. APIサーバを起動
2. アプリを起動
3. ログイン
4. 任意のToDoのチェックボックスをタップする（複数個）

タップしたToDoの完了状態がすぐに反映されることが確認できます。
