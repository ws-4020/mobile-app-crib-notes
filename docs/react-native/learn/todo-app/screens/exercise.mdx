---
title: 演習課題
---

ここまで出来たら、次の演習課題にチャレンジしてください。
サンプルおよびガイドはありません。今までの実装をヒントにできるはずです。

## ユーザ登録画面の作成

ログイン画面を参考に、ユーザ登録画面を作成してください。
その際、ユーザ登録画面のパスワードは4桁以上が必要というチェックを追加してください。

- [ユーザ登録画面](../app-spec.md#ユーザ登録)

## ToDoの削除

ToDoの削除機能を追加してください。

:::note
ToDo一覧画面に削除ボタンを追加する方法が簡単です。
その場合、[確認ダイアログ](alert.mdx)との組み合わせで考えてみてください。
もちろん、違った形で実装しても問題ありません。
:::

## 実装の注意点と不具合の確認

画面の実装時には詳しく説明していませんが、次のような実装には注意が必要です。

 - [ToDo一覧画面](./todo-board.mdx)のステータスの更新処理
 - [ToDo登録画面](./todo-form.mdx)の登録後に自動でModal画面を閉じる処理

上記の処理はREST APIとの接続をすると不具合が顕在化する実装をしてしまうケースがあります。
演習課題では不具合が発生する実装を紹介しますので、実際に不具合を確認し何が問題かを考えてみましょう。


### 関数型のState更新

まず不具合が発生する実装を紹介します。
`TodoBoard.tsx`の`toggleTodoCompletion`を次のように書き換えます。

正しくは`setTodos`に関数を渡す[関数型の更新](https://ja.reactjs.org/docs/hooks-reference.html#functional-updates)を利用すべきですが
この実装ではレンダリング用の値を参照して更新しています。

```typescript title="src/screen/TodoBoard.tsx"
  const toggleTodoCompletion = (id: number) => {
    const target = todos.find((todo) => todo.id === id);
    if (!target) {
      return;
    }
    TodoService.putTodo(id, !target.completed)
      .then((returnedTodo) => setTodos(todos.map((todo) => (todo.id === id ? returnedTodo : todo))))
      .catch(() => {});
  };
```

次に不具合を再現できるように実装を修正しましょう。
REST APIと接続すれば不具合は再現できますが、ここではREST APIと接続した場合と同じ状況を再現します。

`TodoService.ts`の`putTodo`を次のように書き換えます。

```typescript jsx title="/src/services/TodoService.tsx"
const putTodo = async (id: number, completed: boolean) => {
  const target = todos.find((todo) => todo.id === id);
  if (!target) {
    return Promise.reject(new Error('not found'));
  }
  target.completed = completed;
  return new Promise((resolve) => setTimeout(() => resolve({...target}), 2000 + id * 100));
};

```

このように実装することで`Promise`を返す（`resolve`する）までに2秒程度待つことになり、返されるTodoも`TodoService`が参照しているオブジェクトとは別のインスタンスになります。

`TodoBoard.tsx`と`TodoService.tsx`を修正したらアプリを起動して、複数のTodoのステータスを連続して更新してみましょう。

まず、全てのTodoを未完了にします。次に未完了のものを上から順番に連続でタップしてみてください。

全て完了になるはずですが、未完了に戻ってしまうことがあります。

なぜこのような問題が発生するか考えてみてください。

:::note
ヒント：不具合が発生するのはsetTodosで関数型の更新を利用せず、レンダリング時に参照する`todos`をベースに更新していることが関係しています。
:::

### 処理完了後の画面遷移

TODO:不具合が発生する実装と再現させるための実装、再現方法を記載して、原因を考えるためのガイドを書く

:::note
演習課題後は不具合が発生する実装を戻してください。
[TodoService.ts](./todo-board.mdx#todo機能関連の部品)のputTodo,postTodo
[TodoBoard.tsx](./todo-board.mdx#todo一覧画面の作成)
[TodoForm.tsx](./todo-form.mdx)
:::