---
title: タスク登録画面
---

[ToDoアプリの仕様](../app-spec.md)に従い、タスク登録画面をナビゲーション構成に追加します。

修正イメージは次の通りです。

- タスク登録画面（`TodoForm`）のひな型を追加
- `AuthedStackNav`ナビゲータに`TodoForm`という名前でタスク登録画面（`TodoForm`）を配置
- ToDo一覧画面（`TodoBoard`）からタスク登録画面（`TodoForm`）への遷移処理を追加
- タスク登録画面（`TodoForm`）を実装

![TodoFormNavigation](todo_form_navigation.png)

では実装していきましょう。
まずはタスク登録画面（`TodoForm`）を定義します。
次のファイルを追加・修正してください。

- `/src/screens/todo/TodoForm.tsx`
- `/src/screens/todo/index.tsx`

```typescript jsx title="/src/screens/todo/TodoForm.tsx"
import React from 'react';
import {StyleSheet, View} from 'react-native';
export const TodoForm: React.FC = () => {
  return <View style={styles.container}>{/* Todo*/}</View>;
};
const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
});
```

```diff title="/src/screens/todo/index.ts"
  export * from './TodoBoard';
+ export * from './TodoForm';
```

つぎに`AuthedStackNav`ナビゲータに`TodoForm`という名前でタスク登録画面（`TodoForm`）を追加します。
次のファイルを追加・修正してください。

- `/src/navigation/types.ts`
- `/src/navigation/AuthedStackNav.tsx`

```diff title="/src/navigation/types.ts"
  export type UnauthedRootStackParamList = {
    Welcome: undefined;
    Login: undefined;
    Instructions: undefined;
  };
  
  export type AuthedStackParamList = {
    Main: undefined;
+   TodoForm: undefined;
  };
  /* ～省略～ */  
```

```diff title="/src/navigation/AuthedStackNav.tsx"
  import {createStackNavigator} from '@react-navigation/stack';
  import {MainTabNav} from 'navigation/MainTabNav';
  import {AuthedRootStackParamList} from 'navigation/types';
  import React from 'react';
+ import {TodoForm} from 'screens';
  
  const nav = createStackNavigator<AuthedRootStackParamList>();
  export const AuthedStackNav: React.FC = () => {
    return (
      <nav.Navigator screenOptions={{headerShown: false}} initialRouteName="Main">
        <nav.Screen name="Main" component={MainTabNav} />
+       <nav.Screen
+         name="TodoForm"
+         component={TodoForm}
+         options={{
+           headerShown: true,
+         }}
+       />
      </nav.Navigator>
    );
  };
```

```typescript jsx title="/src/screens/todo/TodoForm.tsx"
import {useFormik} from 'formik';
import {useAuthedStackNavigation} from 'navigation/hooks';
import React, {useCallback, useEffect} from 'react';
import {Alert, KeyboardAvoidingView, Platform, StyleSheet, View} from 'react-native';
import {Button, Input, Text} from 'react-native-elements';
import {TodoService} from 'services';
import * as Yup from 'yup';

export const TodoForm: React.FC = () => {
  const navigation = useAuthedStackNavigation<'TodoForm'>();

  const onAdd = useCallback<(values: {task: string}) => void>(
    async ({task}) => {
      await TodoService.postTodo(task);
      navigation.goBack();
    },
    [navigation],
  );

  const formik = useFormik({
    initialValues: {task: ''},
    validationSchema: Yup.object().shape({
      task: Yup.string().required('タスクを入力してください'),
    }),
    validateOnChange: false,
    onSubmit: onAdd,
  });

  useEffect(() => {
    const unsubscribe = navigation.addListener('beforeRemove', (e) => {
      if (!formik.dirty || formik.isSubmitting) {
        return;
      }
      e.preventDefault();

      Alert.alert('破棄確認', '入力内容が保存されていません。\n入力内容を破棄してよろしいですか？', [
        {text: 'Cancel', style: 'cancel', onPress: () => {}},
        {
          text: 'OK',
          style: 'destructive',
          onPress: () => navigation.dispatch(e.data.action),
        },
      ]);
    });
    return unsubscribe;
  }, [navigation, formik]);

  return (
    <KeyboardAvoidingView
      behavior={Platform.select({
        ios: 'padding',
        android: undefined,
      } as const)}
      style={styles.container}>
      <View style={styles.form}>
        <Text h1>タスク登録</Text>
        <Input
          placeholder="タスクを入力してください"
          containerStyle={styles.input}
          autoCapitalize="none"
          errorMessage={formik.errors.task}
          onChangeText={formik.handleChange('task')}
          value={formik.values.task}
        />
        <Button
          disabled={formik.isSubmitting}
          onPress={() => formik.handleSubmit()}
          title="追加"
          buttonStyle={styles.addButton}
        />
      </View>
    </KeyboardAvoidingView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  form: {
    flex: 1,
    alignSelf: 'stretch',
    alignItems: 'center',
    justifyContent: 'center',
  },
  input: {marginTop: 20, width: '80%'},
  addButton: {
    marginTop: 30,
  },
});
```

React同様に、React Naviveでも`useEffect`にて画面の初期（マウント）時の処理を記述できます。
ここでは、`TodoService.getTodos`メソッドを呼び出してToDo一覧を取得しています。

修正できたら実行してください。
次の操作ができたら成功です。

- 画面にToDoタスクの一覧が表示できる
- チェックボックスをクリックしてタスクの完了状態が更新できる
- ToDoの表示対象を選択して表示を切替できる

![TodoForm](todo-form.png)
