---
title: ディープリンクの処理
---

ディープリンクをアプリケーションで処理する方法について記載します。

## ディープリンクタップ時の処理フロー

ユーザがディープリンクをタップするとアプリがフォアグランドで表示します。
その際のアプリスタートの種類によりディープリンクの取り扱いが変わります。
アプリスタートの種類には次のものがあります。

- コールドスタート
- ウォームスタート
- ホットスタート

アプリスタートの種類の詳細は[アプリスタートの種類に応じた初期化処理](../life-cycle-management/overview.mdx#アプリスタートの種類に応じた初期化処理)を参照してください。

処理フローは以下になります。

### ホットスタートの場合

![ディープリンクタップ時(Background)の処理フロー](tap-deep-link-when-background.drawio.png)

ホットスタートの場合、Expo Linkingの[addEventListener](https://docs.expo.dev/versions/latest/sdk/linking/#linkingaddeventlistenertype-handler)に設定した処理が呼ばれます。
この中でURLに応じた処理（画面遷移など）を行います。

### コールドスタートまたはウォームスタートの場合

![ディープリンクタップ時(Quit)の処理フロー](tap-deep-link-when-quit.drawio.png)

React Nativeアプリでは、コールドスタートとウォームスタートはほぼ同等です。
コールドスタートまたはウォームスタートの場合、Expo Linkingの[getInitialURL](https://docs.expo.dev/versions/latest/sdk/linking/#linkinggetinitialurl)で取得したURLに応じた処理（画面遷移など）を行います。

## ディープリンクに応じた画面遷移

このアプリでは、ディープリンクに応じた画面を表示します。

画面遷移時の[Navigation action](https://reactnavigation.org/docs/navigation-actions)は、基本的に`PUSH`を使用します。画面遷移に`PUSH`を利用することにより、戻るボタンをタップした場合にユーザが表示していた画面に戻ることができます。

ただし、ボトムタブを表示しているナビゲーター（[Bottom Tabs Navigator](https://reactnavigation.org/docs/bottom-tab-navigator/)）に遷移する場合は、前の画面に戻ることができないように`NAVIGATE`を使用します。

このアプリでは、`Bottom Tabs Navigator`をログイン（自動ログイン含む）後の初期画面としてNavigation Stackの最初に必ず設定しています。そのため、`NAVIGATE`で画面遷移することによりNavigation Stackの最初まで戻り、前の画面には戻れなくなります。

### 認証状態の考慮

未認証時にディープリンクを受け取った場合は、ディープリンクを無視して通常通り起動するようにします。

その後、ユーザが認証した場合は、未認証時に受け取ったディープリンクの遷移先画面を表示します。

## ディープリンクのバリデーション

ディープリンクによっては、パスパラメータやクエリパラメータを取得して、画面表示時などに使用する場合があります。

これらのパラメータは、攻撃者によってアプリが意図しない値を設定される場合があります。そのため、取得したパラメータは必ずバリデーションを実施します。

バリデーションエラーとなった場合は、ディープリンクを無視して通常通り起動するようにします。
