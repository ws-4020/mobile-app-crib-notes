---
title: ディープリンクの処理
---

ディープリンクURLをアプリケーションで処理する方法について記載します。

## アプリケーションの状態とディープリンクURLの取得

React Native Firebase Dynamic LinksではディープリンクURLを取得するための[API](https://rnfirebase.io/dynamic-links/usage#listening-for-dynamic-links)は次の2つがあります。

- [コールドスタート、ウォームスタート](../life-cycle-management/overview.mdx#コールドスタート、ウォームスタート)では[getInitialLink](https://rnfirebase.io/reference/dynamic-links#getInitialLink)でディープリンクURLを取得します。
  - iOSでは[不具合に対応するため](./react-native-firebase.mdx)にReact Native Linkingを利用します。
- [ホットスタート](../life-cycle-management/overview.mdx#ホットスタート)では[onLink](https://rnfirebase.io/reference/dynamic-links#onLink)でディープリンクURLを取得します。

どちらの場合でもディープリンクURLからコンテンツリンクURLを取得し、画面遷移を判定して、コンテンツリンクURLのパラメータを処理します。コンテンツリンクURLのパラメータは[ディープリンクURLの構成](./create-deep-link.mdx#ディープリンクURLの構成)にあるとおり、スクリーンとパラメータを受け取ります。

[Universal Linksの警告](https://developer.apple.com/documentation/xcode/supporting-universal-links-in-your-app)にもあるようにコンテンツリンクURLが妥当なURLかどうかを検証して、ユーザに情報を表示するなど安全なアクションにとどめてください。コンテンツリンクURLが想定されない値の場合はアプリケーションで利用しません。

### リンクパラメータの保持

リンクパラメータをアプリケーションが取得したとき、（認証が必要など）すぐに処理するページに遷移できないケースがあります。

リンクパラメータをコンテクストに設定してしまうとクリアするタイミングなどの設計が難しく、管理が煩雑になります。

そのため、リンクパラメータを引き継ぐ範囲を決めてナビゲーションのパラメータとして次の画面へ渡すように設計してください。

:::note
[ユーザー エクスペリエンスを向上させる](https://developer.android.com/training/app-links/deep-linking#handling-intents)でも記載されているようにディープリンクから該当のページへの遷移までに多くの画面をまたがないことが好ましいです。
:::

### iOS14以降でのクリップボード利用の通知

iOSではインストール直後にアプリケーションへURLを渡すためにクリップボードを利用します。この機能のため、アプリケーションは初回起動時のみクリップボードの値を読み込みます。

iOS14以降ではクリップボードを読み取るとOSが通知を表示する仕様となっています。そのため、初めてアプリケーションを起動したときのみ、クリップボードに値が存在していると、「`<アプリ名>にSafariからペースト`」のような通知が表示されます。

設定により[クリップボードを無効にする](https://firebase.google.com/docs/dynamic-links/ios/receive?hl=ja#set-up-firebase-and-the-dynamic-links-sdk)こともできますが、インストール後にそのまま起動してディープリンクURLを読み取る機能が利用できません。クリップボードを無効にする場合の警告にあるように`matchType`の値が`week`程度になり、SantokuAppでは`matchType`が`unique`でないディープリンクURLは利用しないからです。[^1]

そのため、このユーザへの通知は制限事項としています。

[^1]:詳しくは[こちら](./react-native-firebase.mdx#他のユーザが開いたディープリンクURLを読み取る可能性がある)を参照してください。

:::note
初回起動時のクリップボードの読み取りは、ドメインが一致するディープリンクURLであれば読み取ります。
ただし、起動したときのディープリングURLが優先されるため、クリップボードから読み取ったという通知は出ますが、クリップボードの値は利用されないというケースもあります。
:::
