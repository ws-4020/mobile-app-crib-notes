---
title: ディープリンク
sidebar_label: Overview
---

ディープリンクとは、AndroidやiOSでURLのリンクを開くとアプリが起動するという仕組みのことです。
ディープリンクから起動されたとき、アプリではそのURLを取得できます。

例えば、リンクを開いたときのURLに応じた画面を表示したり、URLのパラメータから受け取った値を初期値として入力欄に設定しておくなど、幅広く活用できます。ディープリンクを利用しない場合、ユーザはアプリを起動してから手順に従って指定の画面に移動する必要があるなど、使いづらいアプリとなってしまうことがあります。

このアプリでもディープリンクを利用するので、[Firebase Dynamic Links](https://firebase.google.com/docs/dynamic-links)を利用した実現方式を記載します。

## 全体の構成

Firebase Dynamic LinksはOSの機能（[Universal Link（iOS）](https://developer.apple.com/ios/universal-links/)と[App Links(Android)](https://developer.android.com/training/app-links#add-app-links)）を基盤とした機能です。

以降は次の用語を使ってディープリンクとFirebase Dynamic Linksの全体像を紹介します。

|URLの種類|説明|
|:-------|:--|
|ディープリンクURL|ユーザが開くURLで、OSがドメインとの関連を検証するときに利用するURLです。OSの検証が成功するとアプリケーションに渡されます。Dynamic Linksではパラメータ部分にコンテンツリンクURLなどを保持します。|
|コンテンツリンクURL|アプリで表示したいコンテンツをあらわすURLです。（OSの機能だけの場合はディープリンクURLと同じです）Dynamic Linksではアプリと関連付けていないドメインのURLも渡すことができます。|
|ウェブサイト|ディープリンクURLを開いたときにアプリケーションがインストールされていないときに開くサイトです。|
|[プレビューページ](https://firebase.google.com/docs/dynamic-links/link-previews#app_preview_pages)|iOSでディープリンクURLに対応するアプリケーションがインストールされていない場合に表示されるページです。|
|フォールバックURL[^1]|アプリがインストールされていない場合にユーザを誘導するURLです。Androidではウェブサイトから自動でリダイレクトされ、iOSではプレビューページにURLが設定されたボタンで誘導します。アプリのインストール用のURLなどを設定します。|

OSの機能ではディープリンクURLを開くと、下記の図のようにOSがアプリとディープリンクURL（ドメイン）の関連を検証します。
インストールされているアプリケーションとドメインが相互に関連を持っていることが検証できると、対象のアプリケーションを起動してディープリンクURLを渡します。

アプリケーションとドメインの関連については[iOS](https://firebase.google.com/docs/dynamic-links/ios/receive)[^2]と[Android](https://firebase.google.com/docs/dynamic-links/android/receive)を参照してください。

[^1]:ユーザがiOSやAndroid以外のOSでアクセスした場合、フォールバックURLではなく、コンテンツリンクURLをブラウザで開きます。
[^2]:iOSで[関連するドメイン（Associated Domains）](https://help.apple.com/developer-account/#/dev21218dfd6)の機能を利用するためにはADPかADEPライセンスが必要です。

![overview](./overview.drawio.png)

OSの機能では、アプリをインストールしていなければディープリンクURLのウェブサイトを表示します。（ウェブサイトがなければエラー画面が表示されます）

Firebase Dynamic Linksの拡張機能では、未インストールのユーザがディープリンクURLを開くとアプリのインストールページ（フォールバックURL）に誘導します。この際、Androidでは自動的にフォールバックURLが表示され、iOSではフォールバックURLへのリンクのあるプレビューページが表示されます。
さらに、ユーザがアプリをインストールして起動すると①で開いた[ディープリンクURLをアプリに渡せる](https://firebase.google.com/docs/dynamic-links/operating-system-integrations)ため、ユーザがもう一度ディープリンクを開く必要が有りません。

### 利用するライブラリ

React NativeでFirebase Dynamic Linksを利用するために[React Native Firebase Dynamic Links](https://rnfirebase.io/dynamic-links/usage)を利用します。

React Native Linkingを利用してディープリンクURLを受け取ることはできますが、ディープリンクURLからコンテンツリンクURLを取得する機能がありません。また、全体の構成にて破線で示しているDynamic Linksの拡張機能に対応できません。

React Native Firebaseの導入については[React Native Fireabase](https://rnfirebase.io/)と[Dynamic Link](https://rnfirebase.io/dynamic-links/usage)を参照してください。

### ディープリンクURLに対応するウェブサイト

アプリケーションがインストールされていない場合、ディープリンクのURLを開くとブラウザでURLが開かれます。このとき、ディープリンクのURLに対応するウェブサイトが存在していないと、ユーザはコンテンツへの導線を失ってしまいます。インストールしていないユーザの導線を確保するために、ディープリンクを利用する場合はウェブサイトも準備することが望ましいです。

このアプリでは、ウェブサイトとしてDynamic Linksがデフォルトで提供するウェブサイトと[アプリのプレビューページ](https://firebase.google.com/docs/dynamic-links/link-previews#app_preview_pages)を利用します。ウェブサイトやプレビューページではURLに対応するコンテンツ自体は表示できませんが、ストアなどに誘導できるため、ユーザが導線を失うことにはなりません。

### 環境の切り替え

[ビルドバリアント](../../development/build-configuration.mdx)を設定しているためアプリケーションのID（AndroidはアプリケーションID、iOSはBundle Identifier）が切り替わります。

SantokuAppではディープリンクURLを作成して共有するため`react-native-config`と`__DEV__`変数で切り替えられるものに限定します。たとえば、ビルドタイプのReleaseとinhouseは切り替えません。

ビルドバリアントに応じたディープリンクURLサフィックスは次のとおりです。

|プロダクトフレーバー|ビルドタイプ|ディープリンクURLサフィックス|
|:--|:--|:--|
|dev|debug[^3]|`https://devdebugsantokuapp.page.link/`|
|dev|debugAdvanced|`https://devdebugsantokuapp.page.link/`|
|dev|inhouse|`https://devsantokuapp.page.link/`|
|dev|(Release)|`https://devsantokuapp.page.link/`|
||debug[^3]|`https://devdebugsantokuapp.page.link/`|
||debugAdvanced|`https://debugsantokuapp.page.link/`|
||inhouse|`https://santokuapp.page.link/`|
||(Release)|`https://santokuapp.page.link/`|

ビルドバリアント毎にFirebaseアプリを作成してディープリンクURLサフィックスにアプリを設定します。

[^3]:iOSでは高度な機能を利用するため個人デベロッパーアカウントでは利用できません。Androidのみ利用できます。

![テストと本番の設定](./test-setting.drawio.png)
