---
title: ディープリンク
sidebar_label: Overview
---

ディープリンクとは、AndroidやiOSでURLのリンクを開くとアプリが起動するという仕組みのことです。
ディープリンクから起動されたとき、アプリではそのURLを取得できます。

例えば、リンクを開いたときのURLに応じた画面を表示したり、URLのパラメータから受け取った値を初期値として入力欄に設定しておくなど、幅広く活用できます。これらの場合にディープリンクを利用しない場合、ユーザはアプリを起動してから手順に従って指定の画面に移動する必要があるなど、使いづらいアプリとなってしまうことがあります。

このアプリでもディープリンクを利用するので、[Firebase Dynamic Links](https://firebase.google.com/docs/dynamic-links)を利用した実現方式を記載します。

## 全体の構成

Firebase Dynamic LinksはOSの機能（[Universal Link（iOS）](https://developer.apple.com/ios/universal-links/)と[App Links(Android)](https://developer.android.com/training/app-links#add-app-links)）を基盤とした機能です。

以降は次の用語を使ってディープリンクとFirebase Dynamic Linksの全体像を紹介します。

|URLの種類|説明|
|:-------|:--|
|ディープリンクURL|ユーザが開くURLで、OSがドメインとの関連を検証するときに利用するURLです。OSの検証が成功するとアプリケーションに渡されます。|
|コンテンツリンクURL|アプリで表示したいコンテンツをあらわすURLです。（OSの機能だけの場合はディープリンクURLと同じです）Dynamic Linksではアプリと関連付けていないドメインのURLも渡すことができます。|
|ウェブサイト|ディープリンクURLを開いたときにアプリケーションがインストールされていないときに開くサイトです。|
|[プレビューページ](https://firebase.google.com/docs/dynamic-links/link-previews#app_preview_pages)|iOSでディープリンクURLに対応するアプリケーションがインストールされていない場合に表示されるページです。|
|フォールバックURL|アプリがインストールされていない場合にユーザを誘導するURLです。Androidではウェブサイトから自動でリダイレクトされ、iOSではプレビューページにURLが設定されたボタンで誘導します。アプリのインストール用のURLなどを設定します。|

OSの機能ではディープリンクURLを開くと、下記の図のようにOSがアプリとディープリンクURL（ドメイン）の関連を検証します。
インストールされているアプリケーションとドメインが相互に関連を持っていることが検証できると対象のアプリケーションにディープリンクURLを渡します。

アプリケーションとドメインの関連については[iOS](https://firebase.google.com/docs/dynamic-links/ios/receive)[^1]と[Android](https://firebase.google.com/docs/dynamic-links/android/receive)を参照してください。

[^1]:iOSで[関連するドメイン（Associated Domains）](https://help.apple.com/developer-account/#/dev21218dfd6)の機能を利用するためにはADPかADEPライセンスが必要です。

![overview](./overview.drawio.png)

OSの機能では、アプリをインストールしていなければディープリンクURLのウェブサイトを表示します。（ウェブサイトがなければエラー画面が表示されます）

Firebase Dynamic Linksを利用すると、破線で示している未インストールのユーザが[インストールしたあとに、そのままディープリンクURL](https://firebase.google.com/docs/dynamic-links/operating-system-integrations)を利用できます。

### 利用するライブラリ

React NativeでFirebase Dynamic Linksを利用するために[React Native Firebase Dynamic Links](https://rnfirebase.io/dynamic-links/usage)を利用します。

React Native Linkingを利用してディープリンクURLを受け取ることはできますが、ディープリンクURLからコンテンツリンクURLを取得する機能がありません。また、全体の構成にて破線で示しているフローに対応できません。

React Native Firebaseの導入については[React Native Fireabase](https://rnfirebase.io/)と[Dynamic Link](https://rnfirebase.io/dynamic-links/usage)を参照してください。

### ディープリンクURLに対応するWebサイト

アプリケーションがインストールされていない場合、ディープリンクのURLを開くとブラウザでURLが開かれます。このとき、ディープリンクのURLに対応するウェブサイトが存在していないと、ユーザはコンテンツへの導線を失ってしまいます。インストールしていないユーザの導線を確保するために、ディープリンクを利用する場合はウェブサイトも準備することが望ましいです。

本プロジェクトでは、ウェブサイトとしてDynamic Linksがデフォルトで提供するウェブサイトと[アプリのプレビューページ](https://firebase.google.com/docs/dynamic-links/link-previews#app_preview_pages)を利用します。ウェブサイトやプレビューページではURLに対応するコンテンツ自体は表示できませんが、ストアなどに誘導できるため、ユーザが導線を失うことにはなりません。

### 環境とビルドの切り替え

テスト（DevSantokuApp）は本番（SantokuApp）と異なるビルド設定でアプリをビルドします。
モバイルアプリの設定の切り替えは[ビルドバリアント](../../development/build-configuration.mdx)の説明に沿った形式で[Firebaseアプリ](https://firebase.google.com/docs/projects/learn-more)とモバイルアプリをひもづけます。

ディープリンクを利用する場合、ディープリンクURLとドメインの関連を検証するために証明書の情報や署名鍵の情報をFirebaseに登録する必要があります。

 - Firebaseプロジェクト毎にディープリンクURLのドメインを設定します。
 - Firebaseアプリ毎に署名情報を設定します。
   - iOSではビルドに利用する証明書のTeamID（ADPまたはADEPライセンス）をFirebaseアプリに登録します。
   - Androidは署名鍵のSHA256を1つのFireabseアプリに複数設定できるため、ビルドで利用する複数あっても1つのアプリに登録します。
 - Firebase ConsoleでディープリンクURLのドメインにFireabaseアプリを登録します。
 - モバイルアプリケーションは複数のドメインに関連させられるため、ビルド毎に設定を切り替える必要はありません。

![テストと本番の設定](./test-setting.drawio.png)
