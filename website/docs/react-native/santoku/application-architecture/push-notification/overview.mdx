---
title: Push通知
sidebar_label: 概要
---

## Push 通知の全体像

![Push通知のアーキテクチャ](push-notification-architecture.drawio.png)

### デバイス登録トークンの管理

- アカウントID、登録トークン、登録日時の組を保存
- アカウントのログインやログアウト、Push通知送信エラー時に更新される
- Push通知はアカウントに紐づく全デバイスに送信

### FCMの設定

- APNs Auth Keyの設定について
  - p12形式の証明書とp8形式の鍵について
    - p12
      - App ID単位で管理する
      - 本番環境と開発環境で別々に証明書を発行する必要がある
      - 年1年で証明書を更新する必要がある
      - 証明書自体を再ダウンロード可能
      - 証明書ベース
    - p8
      - Apple Developer Programで登録しているApple IDで管理している全てのアプリで使用可能
      - 本番環境と開発環境で同じ証明書を使用できる
      - 有効期限は無期限
      - 証明書は一度しかダウンロードできない(再度作成することは可能)
      - 一つのApple IDで2つまでしか証明書を作成できない
      - Firebaseではp8が推奨されている
      - トークンベース

- FCMの料金とか情報は必要？
- ANPs
  - Development server: api.sandbox.push.apple.com:443
  - Production server: api.push.apple.com:443
  - iOS：デバッグビルドを実行すると、APNトークンが"sandbox"キータイプとしてFCMに登録されます
    - https://rnfirebase.io/releases/v6.4.0

### バックエンドサーバの設定

- サービスアカウント用の秘密鍵は環境変数に保持

### バックエンドサーバとFCMとの連携

- デバイス指定での送信
- 送信効率のためマルチキャスト送信。500件単位に分割して送信。
- FCMから無効なトークンのエラー応答（UNREGISTERD）が返ってきた場合は登録トークンをデータベースから削除

## 関連する決定事項

- [プッシュ通知方式の方針](../../decisions/adr-008-push-notification.mdx)
- [FCM を用いたプッシュ通知の管理方針](../../decisions/adr-009-push-notification-fcm.mdx)
- [プッシュ通知の内容に関する方針](../../decisions/adr-010-push-notification-contents.mdx)
