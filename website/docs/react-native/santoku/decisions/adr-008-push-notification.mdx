---
title: プッシュ通知の方針
---

Status: Proposed

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

TODO: 決まった内容を要約する。

## コンテキスト

TODO: 後で内容を整理して書く。

次の観点でプッシュ通知の方式について議論・調査を進めていきます。

- 通知方式の選定
  - リモート通知、ローカル通知、それ以外の通知方法（WebSocket等）
- 通知の送信に利用するサービス
  - Apple Push Notification service, Firebase Cloud Messaging, Amazon Pinpoint, Azure Notification Hubs等
- デバイス登録トークンの管理方法
  - 登録・更新・削除のタイミング
  - 格納場所
- 通知のグルーピング
- 通知のレート制限
- 通知センターからの削除
- 各OSが用意しているプッシュ通知のオプション機能の利用の要否
  - バッジ
  - 通知音
  - 有効期限
  - 優先度
  - アイコン画像

## 議論

### 通知方式の選定

携帯端末におけるプッシュ通知には、リモート通知とローカル通知の2種類が存在します。
また、携帯端末のOSが持つ通知機能を用いず、アプリそのものに通知機能を持たせたり、既存のサービスを利用することで通知を送信する方式も存在します。
それぞれの概要は以下のとおりです。

#### リモート通知（デバイス単位）

各OSの提供元が提供するプッシュ通知送信用のサービスを介して、アプリがインストールされたユーザ端末へメッセージを送信する機能です。

端末にアプリをインストールして起動した際に、その端末とアプリケーションに対応する固有のデバイストークンが生成されます。
そのデバイストークンを指定してリモート通知を送信することで、デバイストークンに対応する端末のアプリへ通知が届きます。

デバイス単位のリモート通知は、特定のユーザを対象とした内容のメッセージを送信する場合に適しています。
具体的には、以下のような例が挙げられます。

- ユーザが依頼した処理の完了通知
- 確定したサービス利用料金のお知らせ

デバイス単位での送信では、同一メッセージを一度に最大500デバイスに対して送信できます。

#### リモート通知（デバイスグループ単位）

基本的な特性は、リモート通知（デバイス単位）と同様です。

異なる点は、送信先として特定のデバイスを指定するのではなく、特定のデバイスグループに参加している全デバイスへ通知メッセージを送信する点です。
指定したデバイスグループに参加している全デバイスへ同一のメッセージが送信されます。

デバイスグループ単位のリモート通知は、各OSの提供元が提供するプッシュ通知送信用のサービスが持つ機能ではありません。
それらのサービスへのリモート通知を統括管理できる、Firebase Cloud Messagingが提供している機能です。

デバイスグループへ送信するためには、事前にデバイスグループを作成し、デバイスグループに端末のデバイストークンを登録しておくことが必要です。
この処理はFirebase Admin SDKを利用する必要があるためクライアントアプリ側では実施できず、バックエンドサーバ側で端末の登録処理を行う必要があります。

デバイスグループ単位のリモート通知は、比較的少数の決まった送信先へ繰り返しメッセージを送信する場合に適しています。
具体的には、以下のような例が挙げられます。

- 同一ユーザが複数デバイスを利用している場合に、複数のデバイス全てにメッセージを送信

デバイスグループに登録できるデバイスの最大数は20に制限されています。
そのためグループに登録するデバイス数が20を超えることが予想される用途には適していません。

#### リモート通知（トピック単位）

基本的な特性は、リモート通知（デバイス単位）と同様です。

異なる点は、送信先として特定のデバイスを指定するのではなく、特定のトピックを購読している全デバイスへ通知メッセージを送信する点です。
指定したトピックを購読している全デバイスへ、同一のメッセージが送信されます。

トピック単位のリモート通知も、デバイスグループ単位でのリモート通知と同様、Firebase Cloud Messagingが提供している機能です。

トピック単位のリモート通知では、単一のトピックへの送信だけではなく、トピックAとトピックBを両方購読していることなども条件として指定できます。
また、トピックの購読処理はバックエンドサーバだけでなくクライアントアプリからも行えます。

トピック単位のリモート通知は、大量の送信先へ一括でメッセージを送信する場合に適しています。
具体的には、以下のような例が挙げられます。

- ユーザの居住地域に応じて、その地域の天気予報メッセージを送信
- ユーザが興味のあるテーマを設定し、運営者からテーマに応じたメッセージを送信

一方で、FCMのドキュメント内では「レイテンシではなくスループットに対して最適化されます」と記載されています。
通知受信までのレイテンシを重視する場合はデバイス単位、またはデバイスグループ単位での送信が適しています。

Firebase Cloud Messagingでは1アプリあたりのトピック数上限は2000に制限されています。
そのため2000トピックを超えることが予想される用途には適していません。
1トピックあたりの購読者数には制限はありません。

#### ローカル通知

外部からメッセージを送信するのではなく、端末にインストールされたアプリから通知メッセージを送信する方式です。
その特性上、通知メッセージの送信先はその端末に限定され、他のユーザや他の端末へは通知を送信できません。
その代わりに、端末がオフライン状態であっても通知機能を利用できます。

ローカル通知は、外部の情報が必要なくアプリ単体で通知の必要性やタイミングを判断できるケースに適しています。
具体的には、以下のような例が挙げられます。

- アプリ内で実施した非同期処理（ダウンロード処理など）の完了通知
- スケジュールアプリで予定を登録し、予定時刻の数分前にリマインドメッセージを表示
- 音楽プレイヤーアプリでバックグラウンドでの音楽再生中に、再生/停止などの操作を通知領域内で行うためのメッセージを表示

#### WebSocketを用いた通知

AndroidやiOSが提供しているリモート通知機能は、ユーザになじみ深くモバイルアプリでは広く利用されています。
このリモート通知は端末側が受信可能な状態であればかなり高速に配信されるものの、リアルタイムでの通知の到達を保証するものではありません。
また、リモート通知にはデータサイズや送信レートの上限が存在するため、巨大なデータを含む通知を送信したり、高頻度で通知を送信する必要がある場合にも適していません。
許容されるレイテンシに上限がある場合や、高頻度でデータの送受信を行う必要がある場合は、自前でアプリに通知機能を組み込むことも選択肢に入ります。

リアルタイムな通知を実現する方式の1つとして、WebSocketを用いた通知が挙げられます。
WebSocketを用いることで、データに更新があった際にすぐに受信してアプリ内の描画内容を更新できます。
ただし、アプリが前面またはバックグラウンドで稼働した状態である必要があります。

WebSocketを用いた通知は、リアルタイムで高頻度に情報を受信したり、クライアントとサーバで双方向の通信をしたい場合に適しています。
具体的には、以下のような例が挙げられます。

- チャットアプリで受信したメッセージをリアルタイム表示し、こちらからもメッセージを送信
- 宅配アプリで配送中のドライバーの位置をリアルタイムで更新

WebSocketを直接利用するほかに、Firebase Cloud Firestoreのようなリアルタイムな更新データの読み取りに対応したサービスを利用することでも同様の効果が期待できます。

#### その他の既存サービスを用いた通知

OSの通知機能の利用やアプリへの通知機能の組み込みにこだわらず、既存のサービスを利用する形でメッセージを届けることも選択肢の1つです。
SMSやEmailといった既存のサービスを利用することで、アプリをインストールしていないユーザにもメッセージを届けることができます。
また昨今では、LINE通知メッセージを利用してメッセージを届けるケースも出てきています。

#### 今回採用する方式

サンプルアプリケーションでは、誰かが時間割を開始した時に、そのチームに所属する全てのユーザに対してその旨を通知します。
OS標準の通知領域に通知を表示したいことから、今回はリモート通知を採用します。

通知の送信対象となるチームメンバーは20名を超える可能性があります。
そのためデバイスグループ単位でのリモート通知は上限20名の制限に抵触する可能性があるため除外します。

残りのデバイス単位とトピック単位のリモート通知は、どちらでも対応はできそうです。
今回は宛先がそこまで大量ではなく、スループットよりもレイテンシを優先したいことから、
トピック単位でのリモート通知は採用せず、デバイス単位でのリモート通知を採用します。

## 決定

TODO: 決まった内容を書く。
