---
title: ログ出力の方針
---

Status: Accepted

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

:::note
ADRの決定事項を要約して、3行程度で記載してください。
:::

## コンテキスト

モバイルアプリ開発に必要なログ出力機能を次の観点で議論し、ログ出力方式、およびログ出力部品の仕様を決定します。

- ログ出力の用途
- ログ出力に必要な機能
  - ログレベルの設定
  - ログフォーマットの設定
  - ログ出力先の設定
- ログメッセージに含める内容
  - 日時
  - アカウントID
  - エラーコード
  - 起動ID
  - モジュール名
- サードパーティー・ライブラリを使用

## 議論

### ログ出力の用途

ログ出力の用途としては次のものが考えらます。

- デバッグ用途（プログラム処理の追跡など）
- アプリ状態の把握
- エラー発生時の障害解析
- パフォーマンス分析
- ユーザ操作の把握・分析
- セキュリティおよび不正防止のための監査・証跡、および証拠能力

開発時にデバッグ用途でログを活用する場面は多いです。
また運用時においては、アプリで発生したエラーの収集は障害解析する上で必須要件となります。

上記理由から、このアプリに求めるログ出力用途として次を採用します。

- デバッグ用途（プログラム処理の追跡など）
- エラー発生時の障害解析

一方で、次にあげる用途を満たすには、ログ収集のみならず分析視点での考慮・設計が必要となります。

- アプリ状態の把握
- パフォーマンス分析
- ユーザ操作の把握・分析

このアプリとしては過剰要件となるため、上記用途は対象外とします。
ただし、今後の拡張性を考慮して、（主にログ収集を目的とした）出力先の切替機能をログ出力部品として提供します。

セキュリティ用途でログを活用する要件はこのアプリにはありません。
よって、次の用途も対象外とします。

- セキュリティおよび不正防止のための監査・証跡、および証拠能力

### ログ出力に必要な機能

ログ出力に必要な機能として一般的に次の機能があります。

- ログレベルの設定
- ログフォーマットの設定
- ログ出力先の設定

以下、それぞれの機能についての検討結果を示します。

## ログレベルの設定

このアプリではデバッグとエラー発生時の障害解析用途でしかログを使用しません。
そのため、デバッグとエラーのログレベルしか使用しませんが、将来的な拡張性を考慮して次のログレベルを用意することにしました。

- トレース
- デバッグ
- 情報
- 警告
- エラー

## ログフォーマットの設定

デバッグ用途を考えると、ログ出力日時は出力したいです。
また、それ以外の出力項目もアプリの背景や環境（開発環境や本番環境）によって変わる可能性もあるので、柔軟に対応できるようログフォーマットを設定できる機能を用意します。

## ログ出力先の設定

ログ出力先は `console` のほか、ログ収集先への送信があります。
ログ収集については、ログ出力部品に用意する出力先の切替機能を用いて実現することとします。

次の理由によりFirebase Crashlyticsをログ収集先として採用し、そのログ出力部品をデフォルトとして提供します。
リリースビルドのエラーログの場合のみ、Firebase Crashlyticsにログを送信します。

- モバイルアプリのmBaaSとして主流
- プッシュ通知でFirebase Cloud Messagingを使用する

:::caution
次のFirebase Crashlyticsの仕様による注意事項があります。

- ログ送信のタイミングはアプリ再起動時
- 

Firebase Crashlyticsにログを送信するタイミングは、アプリを再起動した時になります。即座にログが送信されないことに注意してください。

:::

### サードパーティー・ライブラリの使用

OSSのログライブラリもいくつか存在します。

- [winston](https://github.com/winstonjs/winston)
- [Bunyan](https://github.com/trentm/node-bunyan)
- [pino](https://github.com/pinojs/pino)
- [loglevel](https://github.com/pimterry/loglevel)
- [npmlog](https://github.com/npm/npmlog)
- [react-native-logs](https://github.com/onubo/react-native-logs)

自作する場合の機能の容易さと外部ライブラリのモジュール管理の煩雑さを考慮して採用はしていません。  
ただしインターフェースに対する実装を切り替えることでアダプター的に利用することは可能と考えます。


## 決定

:::note
最終的な決定内容を記録してください
:::
