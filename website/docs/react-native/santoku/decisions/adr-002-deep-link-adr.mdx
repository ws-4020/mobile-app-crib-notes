---
title: ディープリンク
---

Status: Proposed

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

T.B.W

## コンテキスト

招待コードや一時的なトークンをユーザ間で共有してもらう場合、次のいずれかの方法が考えられます。

- ガイドや操作方法を教えてもらい、アプリをインストールしてから、アプリを起動し該当ページに移動してコードを入力する。
- SNSやQRコードなどで共有されたURLを開き、アプリをインストールし起動する。起動すると該当ページで入力済みになっている。

後者のほうが入力の間違いもなくユーザの操作も少ないため、ユーザ体験が向上することを期待できます。

## 議論

ユーザに共有されたURLからアプリケーションが情報を受け取る方法として、3つの方法を検討しました。

 - OSの機能（Universal Links、Android App Links）を直接利用する
 - FirebaseのDynamic Linksを利用する
 - カスタムURLスキームを利用する

まず、カスタムURLスキームには回避できないセキュリティのリスク[^1]があるため、採用は見送りました。

Firebase Dynamic LinksとOSの機能を直接利用する場合の違いは以下のとおりです。

|観点|Dynamic Links|OSの機能|
|:--|:------------|:------|
|アプリへの誘導|◎|☓|
|セキュリティ|△|○|
|環境の切り分け|△|○|
|設定ファイル|○|○|

[^1]:カスタムURLスキームは自由に設定できるため、作成したURLを別のアプリに乗っ取られるリスクがあります。

### アプリへの誘導

OSの機能を利用する場合、インストールされていないアプリケーションに関連付けられたURLはWebサイトとしてブラウザでアクセスしてしまいます。

たとえばAmazonのお買い物アプリをインストールしていないときにはブラウザでAmazonのサイトにアクセスします。インストールしているとアプリが起動します。
これは、`https://www.amazon.co.jp/apple-app-site-association`にアクセスすれば、関連付けられていることがわかります。

一方でWebサイトのUIを用意していない場合、共有されたURLでアプリケーションをインストールして貰う必要があります。
[Firebase Dynamic Links](https://firebase.google.com/docs/dynamic-links/operating-system-integrations)ではこうしたユースケースをサポートしているため、Webサイトを持たないサービスに適しています。

本プロジェクトでもWebサイトのUIを構築しないため、この機能は有効です。

### セキュリティ

カスタムURLスキームとは異なり、アプリケーションとURL（ドメイン）の関連付けが正当であることをOSが検証しているため、ユーザの操作ミスなどで、他のアプリに情報が意図せず渡ることはありません。
ただし、情報はURLに付与されているため、ユーザ間で共有できる情報に限定します。

認証、認可が必要な場合は取得するためのキー情報や一時的なトークンのみを共有し、情報はAPIから取得します。

#### 🚧iOSのmatchType🚧

Firebase Dynamic Linksには[matchType](https://firebase.google.com/docs/reference/swift/firebasedynamiclinks/api/reference/Enums/DLMatchType.html)があり、`unique`でない場合はユーザが意図しないURLをアプリが受け取っている可能性があります。

matchTypeが`unique`であるか判定してからURLを処理します。

#### iOS14以降のクリップボードについて

Firebase Dynamic Linksでは、インストール直後のアプリケーションとURLを共有するためにクリップボードを利用しています。アプリケーションはこの機能のため、起動時にクリップボードへコピーされている値を読み込んでいます。

iOS14以降ではクリップボードを読み取るとOSが通知を表示する仕様となっています。そのため、アプリケーションを起動すると「`<アプリ名>にSafariからペースト`」のような通知が表示されます。

### 設定ファイル

「OSの機能を直接利用する」場合でも「FirebaseのDynamic Linksを利用する」場合でも設定する内容自体は大きく変わりません。

Dynamic LinksでもOSの機能でもアプリケーションにドメインとの関連付けが必要になります。
設定する作業はFirebaseが簡単ですが、静的なWebサイト上でドメインと関連付けのためにファイルを配置するだけでそこまで大きな差はありません。

Dynamic Linksを利用する場合のみGoogleServiceの設定ファイルが必要です。この設定ファイルを開発者毎にするとなると管理が煩雑になります。（とくにiOSでの開発は個人開発者アカウントを利用してもらいためBundleIdが変わっていまいます）

実際に必要になるものは環境毎（たとえば、開発、外部テスターなどのステージング、本番）設定ファイルです。（これはFirebase Crashlyticsも同様なため、Firebaseを導入するのであれば、設定ファイルを準備することはコスト増にはなりません）

GoogleService-info.plistとアプリケーションのbunndleIdは一致させる必要がないため
個人開発者アカウントを利用する場合でもアカウント毎にアプリの作成は不要です。そのため、開発者が増えるたびに手続きが増えるような問題はありません。

一方でAndriodアプリケーションは`pakcage_name`を一致させる必要がありますが、開発者毎に切り替える必要はないためiOSと同様に3ファイル程度あれば問題ありません。

### 環境の切り分け

OSの機能を利用したディープリンクだけであれば、本番のドメインと開発用のドメインを分ける必要はありません。

設定ファイルにも記載しているようにFirebaseを利用する場合は各環境でアプリを分けます。

:::note
解決方法や選択肢について検討・議論した内容を記録してください。
:::

## 決定

T.B.W

:::note
最終的な決定内容を記録してください
:::
