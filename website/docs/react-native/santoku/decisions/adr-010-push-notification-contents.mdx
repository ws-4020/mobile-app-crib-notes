---
title: プッシュ通知の内容に関する方針
---

Status: Proposed

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

:::note
ADRの決定事項を要約して、3行程度で記載してください。
:::

## コンテキスト

:::note
この決定や変更をしなくてはいけない状況や問題などを説明してください。
:::

次の観点でプッシュ通知に含める内容について議論・調査を進めていきます。

- 通知領域で表現できる内容
- 通知に含められるデータ
- 通知に対するユーザのアクション
- グルーピング
- 通知チャンネル
- 優先度
- 有効期限
- その他のOS固有のオプション

## 議論

### 通知領域で表現できる内容

FCMを介したプッシュ通知では、メッセージの内容として
[公式ドキュメント](https://firebase.google.com/docs/reference/fcm/rest/v1/projects.messages)
に記載されている項目を設定できます。

ここでは、その中から主な項目について検討します。

#### 通知のタイトル・本文・アイコン画像

通知領域に通知内容が表示する際のタイトル、本文、アイコンを指定できます。
サンプルアプリケーションでは、通知のユースケースごとに以下の内容を送信します。

| ユースケース | タイトル | 本文 | アイコン |
|:------------|:--------|:-----|:--------|
|時間割の開始通知|xxx|xxx|xxx|

:::note
Androidの場合、デフォルトでは、通知のテキストコンテンツは1行に収まるように切り詰められます。
通知に表示するテキストを増やしたい場合は、追加のテンプレートを適用することにより、展開可能なテキスト領域を拡大できます
:::

#### 通知音・バイブレーションパターン・LED

TODO: どういう設定ができるかまとめる。

#### バッジ表示

TODO: バッジ表示でできることをまとめる。

### 通知に含められるデータ

<https://firebase.google.com/docs/cloud-messaging/concept-options>

任意の文字列データを格納可能です。
最大ペイロードは4KBです。ただし、Firebaseコンソールからメッセージを送信する場合は例外となり、1,024文字の上限が適用されます。

サンプルアプリケーションでは通知をタップすると、
アプリを起動した上で通知内のデータに応じて適切な画面を開くことを想定しています。
データの形式はJSON形式とし、以下のようなデータを通知に含めて送信します。

```json
{}
```

### 通知に対するユーザのアクション

TODO: 通知上でどういうアクションが可能かまとめる。タップ時やアクションボタンなど。

### グルーピング

<https://firebase.google.com/docs/cloud-messaging/concept-options#which_should_i_use>

- 同じグループの通知を集約して表示できる
- FCMでは同時に配信予約できる折りたたみキーは4種類まで。その範囲に収めるのが望ましい
- 通知頻度が高い場合、グルーピングが設定された通知は配信が遅延させられて同じグループをまとめてから配信される場合がある
- 通知のユースケースごとにグルーピングするか考える必要がある
- 今回のサンプルアプリケーションの通知は時間割の開始通知だけで、通知頻度は低く緊急性もそれほど高くないため、時間割の開始通知として1つのグループにまとめる

### 通知チャンネル

TODO: Androidにおける通知チャンネルについてまとめる。

### 優先度

<https://firebase.google.com/docs/cloud-messaging/concept-options#setting-the-priority-of-a-message>

- Android
  - NORMALとHIGHがある
  - NORMALの場合は、スリープ状態のデバイスには届かない。またバッテリーを節約するために配信を遅らせる場合がある
  - HIGHの場合は、デバイスのスリープ状態を解除して届けられる。バッテリーの消耗につながる可能性がある
  - デフォルトはNORMAL
- iOS
  - 5か10で設定できる
  - 10の場合は即時配信される
  - 5の場合はデバイスの電源状態に応じて届けられる（多分AndroidのNORMALと似たような形）
  - バックグラウンド通知の場合、10に設定することは許可されておらず、5に設定する必要がある

:::note
TODO: 通知の優先度と重要度の違い。

優先度は送る側の設定。
重要度は受け取る側の設定。
:::

### 有効期限

<https://firebase.google.com/docs/cloud-messaging/concept-options#ttl>

- Android
  - 0～2,419,200秒（28日）の間で設定
  - 0を設定した場合は一度だけ配信を試み、到達できなかった場合は即座に破棄される
  - 0以外を設定した場合は、一度配信を試みた後も設定された秒数が経過するまでの間は再試行される
  - 28日がデフォルト
- iOS
  - UNIXエポック秒を設定
  - 0を指定した場合は一度だけ配信を試み、到達できなかった場合は即座に破棄される
  - 0以外を設定した場合は、一度配信を試みた後も設定されたUNIXエポック秒に到達するまでの間は再試行される
  - デフォルト値は、ドキュメント上では明記されていない

通知のユースケースごとに有効期限を検討する必要があります。

サンプルアプリケーションの時間割の開始通知では、
その目的上、翌日以降に通知が届いても役に立たない内容であるため、有効期限は12時間とします。

### その他のOS固有のオプション

TODO: iOSのVoIP Push Notificationなどにも軽く触れる。

## 決定

:::note
最終的な決定内容を記録してください
:::

## 参考：プッシュ通知に関連する各OSのバージョンごとの変更点

### Android

Androidにおける通知機能の互換性については以下を参照してください。
<https://developer.android.com/guide/topics/ui/notifiers/notifications#compatibility>

大きな変更点は以下のとおりです。

- Android 10
  - アプリが独自のアクションボタンを提供しない場合、プラットフォームが通知アクションボタンを自動的に生成
- Android 8.0
  - 通知チャンネル（カテゴリ）を追加
  - 通知バッジ（通知ドット）表示に対応
- Android 7.0
  - 通知のグループ化に対応
  - 通知上からメッセージに直接返信したりテキストを入力できるダイレクト返信アクションの追加
  - 通知テンプレートのスタイルが変更され、ヒーロー画像とアバターが重視されるように
- Android 5.0
  - アプリが通知を発行した瞬間に表示されしばらくすると消えるヘッドアップ通知の導入
  - ロック画面を刷新。通知がロック画面に表示できるように

### iOS

iOS 12以降での通知機能に関する大きな変更点は以下のとおりです。

- iOS 15
  - 集中モードの追加
    - 従来のおやすみモードに加え、運転中、仕事中、睡眠中などのステータスに応じて、さまざまな種類の通知設定が行えるようになる
    - いつ、どのように通知を受けたいか、通知の方法とタイミングをカスタマイズできる
- iOS 12
  - 通知のグループ化に対応
  - おやすみモードの場合、ロック画面で通知が表示されないように変更
