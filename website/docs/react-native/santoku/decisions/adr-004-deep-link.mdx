---
title: ディープリンク
---

Status: Accepted

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

チームにユーザを招待するときに、招待されたユーザが、共有されたURLやQRコードからアプリを開けるようにします。これを実現するために、Firebaseの[Dynamic Links](https://firebase.google.com/docs/dynamic-links)を採用し、以下の方針で利用します。

- アプリケーションを[インストール後もURLを読み取る機能をサポート](https://firebase.google.com/docs/dynamic-links/operating-system-integrations)しているDynamic Linksを採用する。
- ディープリンクのURLに対応するWebサイトは構築しない。
- iOSで意図しないURLが共有されるリスクはアプリケーションで対応する。

## コンテキスト

招待コードをユーザ間で共有してもらう場合、次のいずれかの方法が考えられます。

- ガイドや操作方法を教えてもらい、アプリをインストールしてから、アプリを起動し該当ページに移動してコードを入力する。
- SNSやQRコードなどで共有されたURLを開き、アプリをインストールし起動する。起動すると該当ページで入力済みになっている。

後者のほうが入力の間違いもなくユーザの操作も少ないため、ユーザ体験が向上することを期待できます。

## 議論

ユーザに共有されたURLからアプリケーションが情報を受け取る方法として、3つの方法を検討しました。

 - OSの機能（[Universal Links](https://developer.apple.com/ios/universal-links/)、[Android App Links](https://developer.android.com/training/app-links)）を直接利用する
 - Firebaseの[Dynamic Links](https://firebase.google.com/docs/dynamic-links)を利用する
 - カスタムURLスキームを利用する

まず、カスタムURLスキームには回避できないセキュリティのリスク[^1]があるため、採用は見送りました。

Dynamic LinksとOSの機能を直接利用する場合の違いは以下のとおりです。

|凡例|内容|
|:--|:------------|
|○|問題なし|
|△|軽微な対応が必要|
|☓|対応が難しい|

|観点|Dynamic Links|OSの機能|
|:--|:------------|:------|
|アプリへの誘導[^2]|○|☓|
|アプリケーションの実装|△|x|
|セキュリティ|△|○|
|設定作業の容易さ|○|○|
|環境の切り分け|△|○|

Dynamic LinksはOSの機能と比較すると、アプリへの誘導をサポートしている分、セキュリティや環境の切り分けで対応が必要になります。
またインストールしていないユーザへの導線のためにWebサイトを構築する作業が短縮されます。

:::note
Dynamic Linksを利用すると簡単に組み込めますが、注意する点があります。（セキュリティの課題やReact Nativeアプリの場合、[iOSで起動時間が短いと読み取れないissue](https://github.com/invertase/react-native-firebase/issues/2660)があります）

OSの機能を直接利用したほうがよい場合もあるため、導入するときにはサービスの特性を考慮して利用するか判断します。
:::

[^1]:カスタムURLスキームは自由に設定できるため、作成したURLを別のアプリに乗っ取られるリスクがあります。
[^2]:アプリへの誘導はアプリのインストールを促し、インストール後もURLを読み取れる機能です。

### アプリへの誘導

OSの機能をそのまま利用すると、URLに関連付けられたアプリケーションがインストールされていない場合は、Webサイトと判断されてブラウザでアクセスしてしまいます。
そのため、アプリケーションをインストールしていないユーザ向けに、導線としてのWebサイトも用意する必要があります。

Webサイトでモバイルアプリと同等の機能を用意しなくても、共有されたURLでアプリケーションをインストールするように促すことでユーザをモバイルアプリへ誘導できます。
Dynamic Linksでは、未インストールのユーザに対する導線が簡単に用意できるので、Webサイトを持たないサービスでも簡単にディープリンクを導入できます。

本プロジェクトではアプリを誘導するためのWebサイトを独自に作成せずに、Firebaseで用意しできるWebサイトを利用します。

#### iOS14以降でのクリップボード利用の通知

Dynamic Linksでは、インストール直後のアプリケーションとURLを共有するためにクリップボードを利用しています。この機能のため、アプリケーションは初回起動時のみクリップボードの値を読み込みます。

iOS14以降ではクリップボードを読み取るとOSが通知を表示する仕様となっています。そのため、初めてアプリケーションを起動したときのみ、クリップボードに値が存在していると、「`<アプリ名>にSafariからペースト`」のような通知が表示されます。

### 実装の容易さ

### セキュリティ

カスタムURLスキームとは異なり、アプリケーションとURL（ドメイン）の関連付けが正当であることをOSが検証しているため、他のアプリに情報が意図せず共有されることはありません。

認可が必要な情報を共有する場合は、情報自体をURLに含めず、取得するためのパラメータをURLに含めディープリンクを受け取ったアプリケーション内で（認証したうえで）情報にアクセスします。

#### iOSでの意図しない共有

iOSの場合[^3]、Dynamic Linksには[matchType](https://firebase.google.com/docs/reference/swift/firebasedynamiclinks/api/reference/Enums/DLMatchType.html)があり、`unique`でない場合はユーザが意図しないURLをアプリが受け取っている可能性があります。インストール後にアプリを初回起動したとき、クリップボードに値がない場合、Webサイトから情報を取得することがあります。[^4]

そのため、matchTypeが`unique`であるか判定してからURLを処理します。
この対応で別のユーザがデータを受け取らないようになります。

[^3]: Androidの場合は他のユーザのURLを受け取る事はありません。
[^4]: クリップボードの情報によっては[iOSで受信する ＞ 6.オプションの警告](https://firebase.google.com/docs/dynamic-links/ios/receive?hl=ja#set-up-firebase-and-the-dynamic-links-sdk)にあるように、matchTypeが`unique`にならないケースがあります。クリップボード機能を有効にしていても発生します。

### 設定作業の容易さ

「OSの機能を直接利用する」場合でも「Dynamic Linksを利用する」場合でも設定する内容自体は大きく変わりません。

ディープリンクを利用する場合、「サーバ」と「アプリケーション」の設定作業が必要です。

#### サーバ

Dynamic LinksでもOSの機能でもアプリケーションとドメインとの関連付けが必要になります。関連付けのために、アプリと関連付けるドメインに構築するWebサイト内の定められたパスに、関連付けを定義したファイルを配置します。

<!-- textlint-disable ja-technical-writing/sentence-length -->
`some-app.com`ドメインとアプリを関連付ける場合、サーバ側にも設定ファイルが必要です。
iOSであれば`https://some-app.com/apple-app-site-association`、Androidであれば`https://some-app.com/.well-known/assetlinks.json`に関連付けを定義したファイルを配置します。
<!-- textlint-enable ja-technical-writing/sentence-length -->

Firebaseの`page.link` サブドメインを利用する場合は、WebサイトをFirebaseが構築してくれます。そのため、ホストを構築する作業は少なくなります。

#### アプリケーション

アプリの設定ファイルにドメインの紐付けを設定する作業は共通です。

Dynamic Linksを利用する場合のみGoogleServiceの設定ファイルが必要です。（これは他のFirebaseサービスと同じファイルなので、他にもFirebaseのサービスを利用するのであれば、設定ファイルを準備することはコスト増にはなりません）

必要になるものは環境毎（たとえば、開発、外部テスターなどのステージング、本番）のFirebaseの設定ファイルを想定しています。

### アプリケーションの実装

ディープリンクをReact Nativeで受け取る場合は次のAPIが利用できます。

 - Dynamic Linksを利用する場合は[React Native Firebase](https://rnfirebase.io/dynamic-links/usage)
 - OSの機能は[React Native Linking](https://reactnative.dev/docs/linking#handling-deep-links)

Dynamic Linksを利用する場合は、どちらかのAPIを利用すれば実装できます。ただし、下記の点を考慮しアプリ起動時にはPlatformを判定して呼び分けます。

 - React Native Firebaseには[iOSで起動時間が短いと読み取れないissue](https://github.com/invertase/react-native-firebase/issues/2660)があるためReact Native Linking API
 - React Native Linkingには[AndroidはLikingで読み取れないissue](https://github.com/facebook/react-native/issues/25675)があるためReact Native Firebase API

Dynamic Linksの「インストール後もURLを読み取る機能」を利用するためにはリスナーに[React Native FirebaseのonLink](https://rnfirebase.io/dynamic-links/usage#foreground-events)を利用します。

OSの機能を直接利用する場合（Dynamic Linksを利用しない場合）、AndroidでLinkingが読み取れないissueの原因の調査と対応するための実装、テストが必要です。

### 環境の切り分け

OSの機能を利用したディープリンクだけであれば、本番のドメインと開発用のドメインを分ける必要はありません。

Dynamic Linksではアプリへの誘導をするために、アプリを配信するサイトを指定します。
指定する配信サイトが本番環境だけではテストが難しいため、配信サイトを本番用と開発用に切り分けます。

## 決定

- チーム参加の招待コードを共有する方法としてディープリンクを採用し、Dynamic Linksを採用する。
  - アプリインストール後の[アプリへの誘導](#アプリへの誘導)ができる点を評価し、[iOSでの意図しない共有](#iosでの意図しない共有)は対応する。
  - Android向けにReact Nativeで実装したときのLinkingの不具合はDynamic Linksを利用することで回避する。
- URLのドメインはFirebaseの`page.link`ドメインを利用し、Webサイトは独自で準備しない。
- iOSで意図しないURLが共有されるリスクについてもアプリケーションで対応する。
