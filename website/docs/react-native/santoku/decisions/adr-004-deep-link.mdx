---
title: ディープリンク
---

Status: Accepted

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

ディープリンクの実現方式としてFirebaseの[Dynamic Links](https://firebase.google.com/docs/dynamic-links)を採用し、以下の方針で利用します。

- アプリケーションを[インストール後もURLを読み取る機能をサポート](https://firebase.google.com/docs/dynamic-links/operating-system-integrations)を利用し、モバイルアプリと同等の機能を持つWebサイトは構築しない
- モバイルアプリケーションでは[React Native Firebase Dynamic Links](https://rnfirebase.io/dynamic-links/usage)を利用する。
  - 利用ライブラリの課題はパッチを適用して対応する。

## コンテキスト

ディープリンクを実現する方式は、次の3つの方式から選択します。

 - OSの機能（[Universal Links](https://developer.apple.com/ios/universal-links/)、[Android App Links](https://developer.android.com/training/app-links)）を直接利用する
 - Firebaseの[Dynamic Links](https://firebase.google.com/docs/dynamic-links)を利用する
 - カスタムURLスキームを利用する

## 議論

ディープリンクの3つの実現方式のうち、カスタムURLスキームには回避できないセキュリティのリスク[^1]があるため、採用は見送りました。

Dynamic LinksとOSの機能を直接利用する場合の違いは以下のとおりです。

|凡例|内容|
|:--|:------------|
|○|問題なし|
|△|軽微な対応が必要|
|☓|対応が難しい|

|観点|Dynamic Links|OSの機能|
|:--|:------------|:------|
|アプリへの誘導[^2]|○|☓|
|アプリケーションの実装|△|x|
|セキュリティ|△|○|

Dynamic LinksはOSの機能と比較すると、アプリへの誘導をサポートしている分、セキュリティや環境の切り分けで対応が必要になります。
またインストールしていないユーザへの導線のためにWebサイトを構築する作業が短縮されます。

:::note
Dynamic Linksを利用すると簡単に組み込めますが、注意する点があります。（セキュリティの課題やReact Nativeアプリの場合、[iOSで起動時間が短いと読み取れないissue](https://github.com/invertase/react-native-firebase/issues/2660)があります）

OSの機能を直接利用したほうがよい場合もあるため、導入するときにはサービスの特性を考慮して利用するか判断します。
:::

[^1]:カスタムURLスキームは自由に設定できるため、作成したURLを別のアプリに乗っ取られるリスクがあります。
[^2]:アプリへの誘導はアプリのインストールを促し、インストール後もURLを読み取れる機能です。

### アプリへの誘導

OSの機能をそのまま利用すると、URLに関連付けられたアプリケーションがインストールされていない場合は、Webサイトと判断されてブラウザでアクセスしてしまいます。
そのため、アプリケーションをインストールしていないユーザ向けに、導線としてのWebサイトも用意する必要があります。

Dynamic Linksでは、未インストールのユーザに対する導線が簡単に用意できるので、Webサイトを持たないサービスでも簡単にディープリンクを導入できます。

本プロジェクトではアプリを誘導するためのWebサイトを独自に作成せずに、Firebaseで用意しできるWebサイトを利用します。

#### iOS14以降でのクリップボード利用の通知

Dynamic Linksでは、インストール直後のアプリケーションとURLを共有するためにクリップボードを利用しています。この機能のため、アプリケーションは初回起動時のみクリップボードの値を読み込みます。
[クリップボードを無効にする](https://firebase.google.com/docs/dynamic-links/ios/receive?hl=ja#set-up-firebase-and-the-dynamic-links-sdk)こともできますが、後述する[iOSでの意図しない共有](#iosでの意図しない共有)に対応するためインストール後もURLを読み取る機能が利用できなくなります。

iOS14以降ではクリップボードを読み取るとOSが通知を表示する仕様となっています。そのため、初めてアプリケーションを起動したときのみ、クリップボードに値が存在していると、「`<アプリ名>にSafariからペースト`」のような通知が表示されます。

:::note
初回起動時のクリップボードの読み取りは、ディープリンクでアプリを起動した場合でも形式（`https://関連付けたドメイン`）であれば読み取ります。
ただし、起動したときのディープリングが優先されるため、iOS14以降ではクリップボードから読み取ったという通知は出ますが、クリップボードの値は利用されません。
:::

### アプリケーションの実装

ディープリンクをReact Nativeで受け取る場合は次のライブラリが利用できます。

 - Dynamic Linksを利用する場合は[React Native Firebase](https://rnfirebase.io/dynamic-links/usage)
 - OSの機能は[React Native Linking](https://reactnative.dev/docs/linking#handling-deep-links)

Dynamic Linksを利用する場合は、どちらかのAPIを利用すれば実装できます。ただし、下記の点を考慮しアプリ起動時にはPlatformを判定して呼び分けます。

 - React Native Firebaseには[iOSで起動時間が短いと読み取れないissue](https://github.com/invertase/react-native-firebase/issues/2660)があるためReact Native Linking API
 - React Native Linkingには[AndroidはLikingで読み取れないissue](https://github.com/facebook/react-native/issues/25675)があるためReact Native Firebase API

Dynamic Linksの「インストール後もURLを読み取る機能」を利用するためにはリスナーに[React Native FirebaseのonLink](https://rnfirebase.io/dynamic-links/usage#foreground-events)を利用します。

OSの機能を直接利用する場合（Dynamic Linksを利用しない場合）、AndroidでLinkingが読み取れないissueの原因の調査と対応するための実装、テストが必要です。

### セキュリティ

カスタムURLスキームとは異なり、アプリケーションとURL（ドメイン）の関連付けが正当であることをOSが検証しているため、他のアプリに情報が意図せず共有されることはありません。

認可が必要な情報を共有する場合は、情報自体をURLに含めず、取得するためのパラメータをURLに含めディープリンクを受け取ったアプリケーション内で（認証したうえで）情報にアクセスします。

#### iOSでの意図しない共有

iOSの場合[^3]、Dynamic Linksには[matchType](https://firebase.google.com/docs/reference/swift/firebasedynamiclinks/api/reference/Enums/DLMatchType.html)があり、`unique`でない場合はユーザが意図しないURLをアプリが受け取っている可能性があります。インストール後にアプリを初回起動したとき、クリップボードに値がない場合、Webサイトから情報を取得することがあります。[^4]

そのため、matchTypeが`unique`であるか判定してからURLを処理します。
この対応で別のユーザがデータを受け取らないようになります。

アプリケーションで利用しているReact Native FirebaseではアプリケーションにmatchTypeが渡されないため、ライブラリに[パッチ](https://www.npmjs.com/package/patch-package)を適用する必要があります。

パッチを適用する対象はiOSのみで、FirebaseのSDKではディープリンクのmatchTypeを返しているため、パッチ適用の難易度自体は高くないと判断し、パッチを適用して回避することにしました。

[^3]: Androidの場合は他のユーザのURLを受け取る事はありません。
[^4]: クリップボードの情報によっては[iOSで受信する ＞ 6.オプションの警告](https://firebase.google.com/docs/dynamic-links/ios/receive?hl=ja#set-up-firebase-and-the-dynamic-links-sdk)にあるように、matchTypeが`unique`にならないケースがあります。クリップボード機能を有効にしていても発生します。

### 用語

|用語|意味|備考|
|:--|:--|:--|
|ディープリンク|ユーザをアプリ内の特定のコンテンツに直接誘導するURL。|[Android App Links](https://developer.android.com/training/app-links)|
|カスタムURLスキーム|`mailto:`のようにスキームに任意のプレフィックスを指定したURL||
|Dynamic Links|Firebase Dynamic Links|OSの機能を拡張した機能。カスタムURLは対象外|
|`page.link`サブドメイン|アプリ用のWebサイトが無いときにFirebaseがWebサイトを提供するためのドメイン|[Firebaseガイド](https://firebase.google.com/docs/dynamic-links?hl=ja#custom-link-domains)|

## 決定

- ユーザ間で共有する方法としてディープリンクを採用し、Dynamic Linksを利用する。
  - アプリインストール後の[アプリへの誘導](#アプリへの誘導)ができるため、Webサイトを独自で構築しない。
  - URLのドメインはFirebaseの`page.link`ドメインを利用し、Webサイトは独自で準備しない。
- React Native Firebase Dynamic Linksを採用する。
  - 上記ライブラリを利用して、AndroidのReact Native Linkingの不具合に対応する。
  - [iOSでの意図しない共有](#iosでの意図しない共有)はパッチを適用して回避する。
