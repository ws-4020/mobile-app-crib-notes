---
title: HTTP API通信で発生するエラーのハンドリング
---

Status: Accepted

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

- 以下の場合は、ユーザに適切なエラー内容と復帰手順を伝えます。
  - HTTP APIから400以上のHTTPステータスコードが返却された場合
  - モバイル端末のネットワークがOFFになっていたり、接続先サーバのポートにアクセスできない場合など
- リソースの取得時に、一定時間が経過してもHTTP APIから応答がない場合はタイムアウトさせます。
- HTTP API通信でエラーが発生した場合にリトライ処理を実施しません。代わりに、ユーザ自身がHTTP APIの再試行を選択できるUIを提供することにします。

## コンテキスト

モバイルアプリがHTTP APIと通信する際は、以下のようなエラーが発生する可能性があります。

* HTTPステータスコードが4xx
* HTTPステータスコードが5xx
* HTTP APIの応答に時間がかかってしまい、通信がタイムアウト
* モバイル端末のネットワークがOFFになっていて通信ができない

ここでは、どのようなエラーの場合に共通処理としてエラーのハンドリングを行い、どのような場合に個別処理として実施する必要があるのかを検討します。また、エラーが発生した場合にリトライ処理を実施するかなどについても検討していきます。

なお、HTTP API通信に使用するライブラリとして、[axios](https://github.com/axios/axios)を利用する前提とします。また、HTTP API通信のエラーハンドリングには、[React Query](https://react-query.tanstack.com/overview)を利用する前提とします。

## 議論

### HTTPステータスコードが400以上のエラーハンドリング

HTTP APIとの通信時には、処理が失敗した場合にHTTPステータスコードが400以上のレスポンスが返却されます。SantokuAppでは特定のHTTPステータスコードの場合、ユーザに適切なエラー内容と復帰手順を伝えます。それ以外のHTTPステータスコードの場合は、想定外のエラーが発生したことを促すダイアログを表示します。

| HTTPステータスコード | 意味                                                                              | ハンドリング箇所 |
| :---------------- | :------------------------------------------------------------------------------- | :-- |
| 400               | BadRequest - リクエストとして送るペイロードがバリデーションエラーになった場合など            | 個別 |
| 401               | Unauthorized - 認証トークンの期限が切れた場合                                          | 共通 |
| 404               | Not found - リソースが見つからなかった場合                                             | 個別 |
| 412               | Precondition Failed - 操作しているモバイルアプリケーションが強制アップデート対象の場合       | 共通 |
| 429               | Too Many Requests - クライアントから大量のリクエストが送信された場合                      | 共通 |
| 503               | Service Unavailable - HTTP APIがシステムメンテナンスで止まっている場合                   | 共通 |
| その他             | 想定外のエラーが発生した場合                                                           | 共通 |

#### 403 - Forbiddenは想定外のエラーなのか

2021/08/19時点の仕様だと、リソースにアクセス制限を設けないため403が返却される想定はありません。ただし、使用するミドルウェアやクラウドサービスによっては403が返却される場合もあります。その点については、使用するミドルウェアやクラウドサービスの設計後に追加する可能性はあります。

#### 504 - Gateway Timeoutは想定外のエラーなのか

想定外のエラーとも言えそうですが、時間をおいてから再操作することで正常なレスポンスが返却される場合もあると思われるので、それがわかるようにユーザに伝えるようにします。

#### 401 - Unauthorizedは共通でハンドリングするのか

期限切れの認証トークンをHTTP APIのリクエストとして送信した場合、以下のような処理を実施する想定でした。

1. 期限切れの認証トークンを使用してHTTP APIにリクエストを送信する
1. HTTP APIからHTTPステータスコードが401で返却される
1. HTTPステータスコードが401の場合、SantokuAppでは期限切れの認証トークンを破棄して、認証トークンを再取得する
1. 再取得した認証トークンを使用して、HTTP APIに再度リクエストを送信する

しかし議論を重ねる中で、「HTTP APIのリクエストを送信する前に認証トークンの期限を確認してもいいのでは？」という意見が挙がりました。

1. 認証トークンの期限が切れている、または期限が間近の場合は認証トークンを破棄して、認証トークンを再取得する
1. 認証トークンを使用してHTTP APIにリクエストを送信する

上記の場合だと、HTTPスタータスコードが401で返却されることはなくなり（ログイン処理を除く）、HTTP APIとの通信回数を減らすことができます。よって、HTTPステータスコードが401で返却される場合は共通でエラーハンドリングを実施せず、ログイン処理のみ個別でエラーハンドリングを実施する方針とします。

### HTTP APIからレスポンスが返却されない場合のエラーハンドリング

モバイル端末のネットワークがOFFになっていたり、接続先サーバのポートにアクセスできない場合などは、HTTP APIからレスポンスが返却されません。これらの場合は、共通でエラーのハンドリングを実施してユーザにエラーに内容を伝えます。

### HTTP API通信のタイムアウト

axiosでは、[timeout](https://github.com/axios/axios#request-config)を設定できます。しかし、axiosの`timeout`はAndroidではコネクションタイムアウトのみに使用されるため、コネクション接続後にサーバの応答が遅い場合などはタイムアウトしません。

そのため、SantokuAppではaxiosの`timeout`を使用せず、[CancelToken](https://github.com/axios/axios#cancellation)を利用してHTTP API通信をキャンセルすることによりタイムアウトを実現します。React Queryを使用した場合は、[Query Cancellation](https://react-query.tanstack.com/guides/query-cancellation)が参考になります。

Query Cancellationは、リソースを取得する`useQuery`を使用した場合にHTTP API通信をキャンセルする方法です。リソースの登録や更新時に使用する`useMutation`ではHTTP API通信をキャンセルできません。[^1]

リソースの登録や更新時には、axiosの`CancelToken`を利用して、一定の時間が経過後にHTTP API通信のキャンセル処理を実施することは可能かと思います。しかし、リソースの登録や更新時にHTTP APIを通信をキャンセルした場合、モバイルアプリではHTTP APIの処理が成功したか失敗したかを把握することができません。

モバイルアプリを操作するユーザに正確な情報を伝えることができないのは良くないと考えたため、SantokuAppではリソースの取得時のみHTTP API通信のタイムアウト処理を実施します。

[^1]: `useMutation`を使用した場合のキャンセル機能については、React QueryのGitHubリポジトリで[ディスカッション](https://github.com/tannerlinsley/react-query/discussions/1551)されています。

### HTTP API通信のリトライ

HTTP API通信で発生したエラー内容に応じて、HTTP APIのリクエストを再試行します。リトライ間隔は`1000ms`から始まり、リトライ回数に応じて指数関数的に増えます。（1000ms、2000ms、4000ms...）

| エラー原因                                       | リトライ回数  |
| :--------------------------------------------- | :---------- |
| HTTPステータスコードが400                         | リトライしない |
| HTTPステータスコードが401                         | リトライしない |
| HTTPステータスコードが404                         | リトライしない |
| HTTPステータスコードが412                         | リトライしない |
| HTTPステータスコードが429                         | 2回          |
| HTTPステータスコードが503                         | リトライしない |
| HTTPステータスコードが504                         | 2回          |
| HTTPステータスコードが上記以外                      | 2回          |
| HTTP APIからレスポンスが返却されない場合             | 2回          |

#### リトライは本当に必要か

HTTP API通信をする場合、HTTP APIからの応答が返ってくるまでは他の操作をできないようにする機能もあるかと思います。そういった場合に自動でリトライすると、リトライ数に応じた時間だけユーザは操作できずに待ち続けなければいけません。ユーザによってはそれがストレスに感じる方もいるかと思います。

そのため、SantokuAppではHTTP API通信でエラーが発生した場合に自動で再試行しない方針とします。代わりに、ユーザ自身の操作でHTTP APIを再試行できるUIを提供することにします。

## 決定

### HTTPステータスコードが400以上のエラーハンドリング

特定のHTTPステータスコードの場合、ユーザに適切なエラー内容と復帰手順を伝えます。それ以外のHTTPステータスコードの場合は、想定外のエラーが発生したことを促すダイアログを表示します。

| HTTPステータスコード | SantokuAppで発生する場面                                                           | ハンドリング箇所 |
| :---------------- | :------------------------------------------------------------------------------- | :-- |
| 400               | BadRequest - リクエストとして送るペイロードがバリデーションエラーになった場合など            | 個別 |
| 401               | Unauthorized - ログイン処理で、不正な認証情報を送信した場合                              | 個別 |
| 404               | Not found - リソースが見つからなかった場合                                             | 個別 |
| 412               | Precondition Failed - 操作しているモバイルアプリケーションが強制アップデート対象の場合       | 共通 |
| 429               | Too Many Requests - クライアントから大量のリクエストが送信された場合                      | 共通 |
| 503               | Service Unavailable - HTTP APIがシステムメンテナンスで止まっている場合                   | 共通 |
| 504               | Gateway Timeout - HTTP APIから時間内に応答がなかった場合                               | 共通 |
| その他             | 想定外のエラーが発生した場合                                                           | 共通 |

### HTTP APIからレスポンスが返却されない場合のエラーハンドリング

モバイル端末のネットワークがOFFなどでHTTP APIからレスポンスが返却されない場合は、共通でエラーのハンドリングを実施してユーザにエラーに内容を伝えます。

### HTTP API通信のタイムアウト

リソースを取得する場合は、一定時間が経過してもHTTP APIから応答がない場合はタイムアウトさせます。リソースの登録や更新をする場合はタイムアウトしません。

### HTTP API通信のリトライ

HTTP API通信でエラーが発生した場合にリトライ処理を実施しません。代わりに、ユーザ自身がHTTP APIの再試行を選択できるUIを提供することにします。
