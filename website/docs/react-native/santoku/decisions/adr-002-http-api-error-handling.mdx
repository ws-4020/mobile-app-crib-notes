---
title: HTTP API通信で発生するエラーのハンドリング
---

Status: Accepted

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

:::note
ADRの決定事項を要約して、3行程度で記載してください。
:::

## コンテキスト

モバイルアプリがHTTP APIと通信する際は、以下のようなエラーが発生する可能性があります。

* HTTPステータスコードが4xx
* HTTPステータスコードが5xx
* HTTP APIの応答に時間がかかってしまい、通信がタイムアウト
* モバイル端末のネットワークがOFFになっていて通信ができない

ここでは、どのようなエラーの場合に共通処理としてエラーのハンドリングを行い、どのような場合に個別処理として実施する必要があるのかを検討します。また、エラーが発生した場合にリトライ処理を実施するかなどについても検討していきます。

## 議論

### HTTPステータスコードが400以上のエラーハンドリング

HTTP APIとの通信時には、処理が失敗した場合にHTTPステータスコードが400以上のレスポンスが返却されます。SantokuAppでは以下のHTTPステータスコードの場合、ユーザに適切なエラー内容と復帰手順を伝えます。ここに含まれないHTTPステータスコードの場合は、想定外のエラーが発生したことを促すダイアログを表示します。

| HTTPステータスコード | 意味                                                                              | ハンドリング箇所 |
| :---------------- | :------------------------------------------------------------------------------- | :-- |
| 400               | BadRequest - リクエストとして送るペイロードがバリデーションエラーになった場合など            | 個別 |
| 401               | Unauthorized - 認証トークンの期限が切れた場合                                          | 共通 |
| 404               | Not found - リソースが見つからなかった場合                                             | 個別 |
| 412               | Precondition Failed - 操作しているモバイルアプリケーションが強制アップデート対象の場合       | 共通 |
| 429               | Too Many Requests - クライアントから大量のリクエストが送信された場合                      | 共通 |
| 503               | Service Unavailable - HTTP APIがシステムメンテナンスで止まっている場合                   | 共通 |

#### 403 - Forbiddenは想定外のエラーなのか

2021/08/19時点の仕様だと、リソースにアクセス制限を設けないため403が返却される想定はありません。ただし、使用するミドルウェアやクラウドサービスによっては403が返却される場合もあります。その点については、使用するミドルウェアやクラウドサービスの設計後に追加する可能性はあります。

#### 504 - Gateway Timeoutは想定外のエラーなのか

想定外のエラーとも言えそうですが、時間をおいてから再操作することで正常なレスポンスが返却される場合もあると思われるので、それがわかるようにユーザに伝えるようにします。

#### 401 - Unauthorizedは共通でハンドリングするのか

期限切れの認証トークンをHTTP APIのリクエストとして送信した場合、以下のような処理を実施する想定でした。

1. 期限切れの認証トークンを使用してHTTP APIにリクエストを送信する
1. HTTP APIからHTTPステータスコードが401で返却される
1. HTTPステータスコードが401の場合、SantokuAppでは期限切れの認証トークンを破棄して、認証トークンを再取得する
1. 再取得した認証トークンを使用して、HTTP APIに再度リクエストを送信する

しかし議論を重ねる中で、「HTTP APIのリクエストを送信する前に認証トークンの期限を確認してもいいのでは？」という意見が挙がりました。

1. 認証トークンの期限が切れている、または期限が間近の場合は認証トークンを破棄して、認証トークンを再取得する
1. 認証トークンを使用してHTTP APIにリクエストを送信する

上記の場合だと、HTTPスタータスコードが401で返却されることはなくなり（ログイン処理を除く）、HTTP APIとの通信回数を減らすことができます。よって、HTTPステータスコードが401で返却される場合は共通でエラーハンドリングを実施せず、ログイン処理のみ個別でエラーハンドリングを実施する方針とします。

### HTTP APIからレスポンスが返却されない場合のエラーハンドリング

モバイル端末のネットワークがOFFになっていたり、接続先サーバのポートにアクセスできない場合などは、HTTP APIからレスポンスが返却されません。これらの場合は、共通でエラーのハンドリングを実施してユーザにエラーに内容を伝えます。

## 決定

:::note
最終的な決定内容を記録してください
:::
