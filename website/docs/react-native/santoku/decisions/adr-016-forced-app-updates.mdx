---
title: 強制アプリアップデート
---

Status: Accepted

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

重大なゼロデイ脆弱性を検知した場合や外部サービスのインターフェースが変更された場合などに対応するため、以下の方針でアプリのアップデート要否を確認します。

- アップデート要否の確認はアプリ起動時に実施する
- アプリから端末のOSとアプリのバージョンをバックエンドAPIに送信して、アップデート要否を受け取る

## コンテキスト

モバイルアプリでは、アプリのアップデートタイミングはユーザに委ねられており、基本的には提供元がコントロールできません。
しかし、重大なゼロデイ脆弱性を検知した場合や外部サービスのインターフェースが変更された場合など、ユーザの利用しているアプリを強制的にアップデートさせたいという要求は少なからずあります。

そのため、アップデートするまでユーザがアプリを利用できないようにする仕組みを検討します。

:::info前提
前提として、アプリのアップデートはApp StoreやGoogle Play Storeを介して行うものとします。
[Expo Updates](https://docs.expo.dev/versions/latest/sdk/updates/)などを使用したOTAアップデートは対象外とします。
:::

## 議論

### アップデート要否の確認タイミング

アップデート要否の確認タイミングとしては、以下の候補が挙がりました。

- アプリ起動時
- アプリ起動時 + アプリ復帰時（バックグラウンドからフォアグラウンドに移行時）
- アプリ起動時 + バックエンドAPIとの通信時
- （可能な限り）即時

アプリ起動時のみ確認する場合に比べると、他の候補はユーザに対してアップデートを要求する機会が増えます。
その反面、開発コストも増えます。即時に確認する場合は、外部サービスの導入や新しい技術スタックの追加が必要になります。

そのため、このアプリではアプリ起動時のみアップデート要否を確認することにします。アプリを長時間起動しているユーザには、アップデートを要求するタイミングが遅れてしまいますが、それは許容します。

### アップデート要否の確認方法

このシステムにはアプリから接続するバックエンドAPIがあるため、アップデート要否の確認はバックエンドAPIで実施することにしました。

アプリからは、以下の情報をバックエンドAPIに送信します。

- 端末のOS
  - iOS
  - Android
- 使用しているアプリのバージョン

これらの情報を元に、バックエンドAPIではアップデート要否を確認後、結果をレスポンスとして返却します。

:::info参考情報
今回は、アプリ起動時にアップデート要否を確認するのみだったので、既存のバックエンドAPIで実施しました。
しかし、即時、または定期的にアップデート要否を確認したい場合などは、以下のようなサービスの利用も検討すると良いでしょう。

- [Firebase Remote Config](https://firebase.google.com/docs/remote-config?hl=ja)
- [Firebase Cloud Firestore](https://firebase.google.com/docs/firestore?hl=ja)

:::

## 決定

- アップデート要否の確認はアプリ起動時に実施する
- アプリから端末のOSとアプリのバージョンをバックエンドAPIに送信して、アップデート要否を受け取る
