---
title: 強制アプリアップデート
---

Status: Accepted

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

セキュリティ脆弱性を検知した場合や外部サービスのインターフェースが変更された場合などに対応するため、以下の方針でアプリのアップデート要否を確認します。

- アップデート対象の確認はアプリ起動時に実施する
- アプリから端末のOSとアプリのバージョンをバックエンドAPIに送信して、アップデート要否を受け取る
- アップデート対象となった場合は、アップデートを要求するダイアログを表示する

## コンテキスト

モバイルアプリのアップデートは、ユーザが自身で行う必要があります。しかし、セキュリティ脆弱性を検知した場合や外部サービスのインターフェースが変更された場合など、アプリを強制的にアップデートしたいケースがあります。

そういったケースに対応するため、特定のバージョン以下のアプリを強制的にアップデートする仕組みを検討します。

## 議論

### アップデート対象の確認タイミング

アップデート対象の確認タイミングとしては、以下の候補が挙がりました。

- アプリ起動時
- アプリ起動時 + アプリ復帰時（バックグラウンドからフォアグラウンドに移行時）
- アプリ起動時 + バックエンドAPIとの通信時
- （可能な限り）即時

アプリ起動時のみ確認する場合に比べると、他の候補はユーザに対してアップデートを要求する機会が増えます。
その反面、開発コストも増えます。即時に確認する場合は、外部サービスの導入や新しい技術スタックの追加が必要になります。

そのため、このアプリではアプリ起動時のみアップデート対象の確認を実施することにします。アプリを長時間起動しているユーザには、アップデートを要求するタイミングが遅れてしまいますが、それは許容します。

### アップデート対象の確認方法

このシステムにはアプリから接続するバックエンドAPIがあるため、アップデート対象の確認はバックエンドAPIで実施することにしました。

アプリからは、以下の情報をバックエンドAPIに送信します。

- 端末のOS
  - iOS
  - Android
- 使用しているアプリのバージョン

これらの情報を元に、バックエンドAPIではアップデート対象の確認を実施後、アップデート要否をレスポンスとして返却します。
アプリは、レスポンスから受け取ったアップデート要否に基づいて、アップデートを要求するダイアログを表示します。

また、アプリをアップデートするまでは、このアプリの機能を使用できないようにします。

:::info参考情報
今回は、アプリ起動時にアップデート対象の確認するのみだったので、既存のバックエンドAPIで実施しました。
しかし、即時、または定期的にアップデート対象の確認をしたい場合などは、以下のようなサービスの利用も検討すると良いでしょう。

- [Firebase Remote Config](https://firebase.google.com/docs/remote-config?hl=ja)
- [Firebase Cloud Firestore](https://firebase.google.com/docs/firestore?hl=ja)

:::

## 決定

- アップデート対象の確認はアプリ起動時に実施する
- アプリから端末のOSとアプリのバージョンをバックエンドAPIに送信して、アップデート要否を受け取る
- アップデート対象となった場合は、アップデートを要求するダイアログを表示する
