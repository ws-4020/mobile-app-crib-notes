---
title: ディープリンク
---

Status: Accepted

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

チームにユーザを招待するときに、招待されたユーザが、共有されたURLやQRコードからアプリを開けるようにします。これを実現するために、Firebaseの[Dynamic Links](https://firebase.google.com/docs/dynamic-links)を採用し、以下の方針で利用します。

- アプリケーションを[インストール後もURLを読み取る機能をサポート](https://firebase.google.com/docs/dynamic-links/operating-system-integrations)しているDynamic Linksを採用する。
- ディープリンクのURLに対応するWebサイトは構築しない。
- iOSで意図しないURLが共有されるリスクはアプリケーションで対応する。

## コンテキスト

招待コードをユーザ間で共有してもらう場合、次のいずれかの方法が考えられます。

- ガイドや操作方法を教えてもらい、アプリをインストールしてから、アプリを起動し該当ページに移動してコードを入力する。
- SNSやQRコードなどで共有されたURLを開き、アプリをインストールし起動する。起動すると該当ページで入力済みになっている。

後者のほうが入力の間違いもなくユーザの操作も少ないため、ユーザ体験が向上することを期待できます。

## 議論

ユーザに共有されたURLからアプリケーションが情報を受け取る方法として、3つの方法を検討しました。

 - OSの機能（Universal Links、Android App Links）を直接利用する
 - Firebaseの[Dynamic Links](https://firebase.google.com/docs/dynamic-links/operating-system-integrations)を利用する
 - カスタムURLスキームを利用する

まず、カスタムURLスキームには回避できないセキュリティのリスク[^1]があるため、採用は見送りました。

Dynamic LinksとOSの機能を直接利用する場合の違いは以下のとおりです。

|凡例|内容|
|:--|:------------|
|◎|有効|
|○|問題なし|
|△|軽微な対応が必要|
|☓|対応が難しい|

|観点|Dynamic Links|OSの機能|
|:--|:------------|:------|
|アプリへの誘導[^2]|◎|☓|
|セキュリティ|△|○|
|設定作業の容易さ|○|○|
|環境の切り分け|△|○|

Dynamic LinksはOSの機能と比較すると、アプリへの誘導をサポートしている分、セキュリティや環境の切り分けで対応が必要になります。

[^1]:カスタムURLスキームは自由に設定できるため、作成したURLを別のアプリに乗っ取られるリスクがあります。
[^2]:アプリへの誘導はアプリのインストールを促し、インストール後もURLを読み取れる機能です。

### アプリへの誘導

OSの機能をそのまま利用すると、URLに関連付けられたアプリケーションがインストールされていない場合は、Webサイトと判断されてブラウザでアクセスしてしまいます。
そのため、アプリケーションをインストールしていないユーザ向けに、導線としてのWebサイトも用意する必要があります。

Webサイトを用意していない場合、共有されたURLでアプリケーションをインストールするように促すことでユーザをアプリへ誘導できます。
Dynamic Linksでは、未インストールのユーザに対する導線が簡単に用意できるので、Webサイトを持たないサービスでも簡単にディープリンクを導入できます。

本プロジェクトでもWebサイトを構築しないため、Dynamic Linksのこの機能は有効です。

### セキュリティ

カスタムURLスキームとは異なり、アプリケーションとURL（ドメイン）の関連付けが正当であることをOSが検証しているため、他のアプリに情報が意図せず共有されることはありません。
ただし、情報はURLに付与されているため、ユーザ間で共有できる情報に限定します。

認証、認可が必要な場合は取得するためのパラメータや一時的なトークンのみをURLに含め、保護したい情報はAPIから取得します。

#### iOSでの意図しない共有

iOSの場合[^3]、Dynamic Linksには[matchType](https://firebase.google.com/docs/reference/swift/firebasedynamiclinks/api/reference/Enums/DLMatchType.html)があり、`unique`でない場合はユーザが意図しないURLをアプリが受け取っている可能性があります。

そのため、matchTypeが`unique`であるか判定してからURLを処理します。
この対応でユーザが意図しないデータを受け取らないように保護します。

[^3]: Androidの場合は他のユーザのURLを受け取る事はありません。

#### iOS14以降でのクリップボード利用の通知

Dynamic Linksでは、インストール直後のアプリケーションとURLを共有するためにクリップボードを利用しています。アプリケーションはこの機能のため、初回起動時にクリップボードへコピーされている値を読み込んでいます。

iOS14以降ではクリップボードを読み取るとOSが通知を表示する仕様となっています。そのため、初めてアプリケーションを起動したときのみ、クリップボードに値が存在していると、「`<アプリ名>にSafariからペースト`」のような通知が表示されます。

### 設定作業の容易さ

「OSの機能を直接利用する」場合でも「Dynamic Linksを利用する」場合でも設定する内容自体は大きく変わりません。

ディープリンクを利用する場合、「サーバ」と「アプリケーション」の設定作業が必要です。

#### サーバ

Dynamic LinksでもOSの機能でもアプリケーションとドメインとの関連付けが必要になります。関連付けのために、アプリと関連付けるドメインに構築するWebサイト内の定められたパスに、関連付けを定義したファイルを配置します。

`some-app.com`ドメインとアプリを関連付ける場合、`https://some-app.com/apple-app-site-association`に関連付けを定義したファイルが必要です。

Firebaseの`page.link`ドメインを利用できるためホストを準備しなくてよい分Dynamic Linksのほうが作業は少なくなります。ただし、Firebaseを利用しなくても静的なWebサイトにドメインとアプリを関連付けるファイルを配置するだけでそこまで大きな差はありません。

#### アプリケーション

アプリの設定ファイルにドメインの紐付けを設定する作業は共通です。

Dynamic Linksを利用する場合のみGoogleServiceの設定ファイルが必要です。（これは他のFirebaseサービスと同じファイルなので、他にもFirebaseのサービスを利用するのであれば、設定ファイルを準備することはコスト増にはなりません）

必要になるものは環境毎（たとえば、開発、外部テスターなどのステージング、本番）設定ファイルを想定しています。

### 環境の切り分け

OSの機能を利用したディープリンクだけであれば、本番のドメインと開発用のドメインを分ける必要はありません。

Dynamic Linksではアプリを配信するサイトを切り分けるため本番用と開発用に切り分けます。

## 決定

- チーム参加の招待コードを共有する方法としてディープリンクを採用し、Dynamic Linksを採用する。
  - アプリインストール後にもチーム参加をサポートする点を評価し、セキュリティなどは対応する。
- URLのドメインはFirebaseの`page.link`ドメインを利用し、Webサイトは独自で準備しない。
- iOSで意図しないURLが共有されるリスクについてもアプリケーションで対応する。
