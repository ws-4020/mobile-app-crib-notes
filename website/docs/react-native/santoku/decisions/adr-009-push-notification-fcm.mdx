---
title: FCMを用いたプッシュ通知の管理方針
---

Status: Proposed

<!--
Proposed: 提案中
Accepted: 採用
Rejected: 却下
Superseded: 廃止
-->

## 要約

:::note
ADRの決定事項を要約して、3行程度で記載してください。
:::

## コンテキスト

:::note
この決定や変更をしなくてはいけない状況や問題などを説明してください。
:::

次の観点でFCMを用いたプッシュ通知の管理方針について議論・調査を進めていきます。

- デバイス登録トークンの管理
- レート制限
- エラーハンドリング

## 議論

### 登録トークンの管理

[FCM登録トークン管理のベストプラクティス](https://firebase.google.com/docs/cloud-messaging/manage-tokens)が公式のドキュメントとして用意されています。
サンプルアプリケーションでも原則このベストプラクティスに従うものとします。

#### 登録トークンの保存

各デバイスの登録トークンは、バックエンドサーバに保存します。
この際に、登録トークンに加えて、登録トークン生成日時のタイムスタンプもあわせて保存しておきます。
登録トークン生成日時を保存しておくことで、登録トークンの定期更新の基準にできます。

サンプルアプリケーションではログイン前の端末へは通知を送信しないため、
ログインが完了したタイミングで登録トークンを生成しバックエンドサーバへ保存します。

iOS端末の場合、登録トークンの生成前に、このアプリからの通知の送信を許可するか確認するダイアログを表示する必要があります。
ここで通知の送信をユーザが拒否した場合は、登録トークンの生成・保存は行いません。

:::info
iOS端末の場合、通知機能を利用する前にアプリ内で通知送信の許可を求めるダイアログを表示し、ユーザの意思を確認する必要があります。
それをユーザが拒否した場合、以降アプリ内では許可を求めるダイアログを再表示できず、
ユーザがOSの設定からアプリの通知をオンに設定しない限り通知機能は利用できません。

しかし少なくないユーザは、通知が何の目的で用いられるのか説明される前に許可を求めるダイアログが表示されると、許可しないを選択します。
これはユーザの体験を向上させる目的で通知機能を提供しているアプリにとって不幸なすれ違いです。

この問題を改善するために、例えば以下のような方法を採用できます。

#### プッシュ通知が本当に必要になるタイミングで通知許可を要求する

例えば、特定の条件を満たした場合に通知を受け取るという設定がアプリ内に存在するとします。
この設定をオンに設定したタイミングで通知許可ダイアログを表示した場合、ユーザはこの通知を受け取るために通知の許可を要求しているのだと明確に理解できます。

#### プッシュ通知の目的を説明する画面を用意し、その画面で通知の目的に同意したユーザにのみiOSの提供する通知許可ダイアログを表示する

iOSが用意している通知許可ダイアログは一度しか表示できません。
そのため何度でも表示できる別の画面で一度ユーザの意向を確認した上で、同意してくれたユーザにのみiOSの提供する通知許可ダイアログを表示します。
用意した画面で同意しなかったユーザに対しても、後からいつでもその画面に遷移して通知を許可できるようにします。

#### アプリからOSの通知設定画面へ誘導する

一度iOSの通知許可ダイアログで拒否された場合、OSのアプリ設定の画面からしか通知設定は変更できません。
通知を有効化する方法をアプリ内で説明し、アプリ設定画面を開くためのボタンなどを用意しておくことで、設定を変更してもらえる可能性が高まります。
ただし、ユーザの意思を尊重せずに通知の有効化を強要するようなデザインにしてしまうと、各OSのストア公開審査で規約違反と判断される可能性があります。
:::

#### 登録トークンの更新

登録トークンは以下の場合などに無効化されます。

- アプリが元のデバイスから新しいデバイスに復元される
- ユーザがアプリをアンインストールまたは再インストールする
- ユーザがアプリデータをクリアする

また、後述する登録トークンの削除のタイミングでは、バックエンドサーバから登録トークンを削除します。

サンプルアプリケーションでは、ログイン（自動ログイン含む）時にこれらをチェックするものとします。
端末側で登録トークンが無効化されていた場合、またはバックエンドサーバ上で登録トークンが削除されていた場合は、
登録トークンを再生成してバックエンドサーバに保存します。
ただし、OSのアプリ設定で通知がオフに設定されている場合、再生成・保存は行いません。

また登録トークンが無効化された場合だけでなく、登録トークン生成日時をもとに定期的に登録トークンを更新します。
登録トークンを定期的に更新することで、アプリが起動されなくなり更新されなくなった古い登録トークンを判別できるようになります。
これにより、アプリが起動されなくなったデバイスをプッシュ通知の送信対象から除外できます。
これは、大量のデバイスへ通知を送信するユースケースでのレート制限の回避やパフォーマンス改善につながります。

FCMでは、月に1度程度登録トークンを更新し、生成から2か月以上経過した古い登録トークンに対し、デバイス登録解除やトピック購読解除を行うことを推奨しています。
サンプルアプリケーションでもそれに倣い、月に1度登録トークンを更新し、生成から2か月以上経過した古い登録トークンのデバイス登録を解除するものとします。

#### 登録トークンの削除

FCMは、無効なトークンに対する通知送信リクエストを受け取った場合に、以下のエラー応答を返します。

- UNREGISTERD (HTTP 404)
  - 指定した登録トークンがそのアプリに対して登録されていない場合に返されます
- INVALID_ARGUMENT (HTTP 400)
  - リクエストパラメータに問題がある場合に返されます
  - 登録トークンが問題の原因である場合は、Invalid registrationという理由が返されます

UNREGISTERDが返された場合は登録トークンが無効であるため、バックエンドサーバから登録トークンを削除します。
またINVALID_ARGUMENTが返されて理由がInvalid registrationだった場合も同様に登録トークンを削除します。

アプリ起動時にOSのアプリ設定で通知がオフに設定されている場合も、バックエンドサーバから登録トークンを削除します。

今回のサンプルアプリケーションではログインしている端末にのみ通知を送信したいため、ログアウト時にも登録トークンを削除します。

### レート制限

#### FCMが定める上限

- 1台のデバイスに送信できるメッセージ
  - 1分あたり最大240件
  - 1時間あたり最大5000件
- アップストリームメッセージの制限
  - プロジェクトあたり1500000件/分
  - デバイスあたり1000件/分
- トピック・デバイスグループを対象とした送信（ファンアウト）
  - プロジェクトあたりの同時ファンアウト数1000
  - プロジェクトあたりのファンアウト数10000 QPS
- トピック登録・解除の制限
  - トピック登録の追加・解除はプロジェクトごとに3000 QPS

#### APNsが定める上限

通知に関する送信上限について明確に記載された最新のドキュメントは見つけられませんでした。

Appleのドキュメントアーカイブに残されている過去のドキュメントとしては、
[Troubleshooting Push Notifications](https://developer.apple.com/library/archive/technotes/tn2265/_index.html)がありました。
ここでは、"There are no caps or batch size limits for using APNs."と記載されています。

しかしAPNsが返しうるステータスコードの中には429が含まれています。
その理由としては、"The server received too many requests for the same device token."と記載されています。
そのため、同一のデバイスにあまりにも高頻度に送信すると制限されることが予想されます。

### エラーハンドリング

#### エラー応答の種類

エラー応答については、以下の公式ドキュメントに詳細が記載されています。

- [FCM HTTP v1 API (現行最新のAPI)](https://firebase.google.com/docs/reference/fcm/rest/v1/projects.messages)
- [FcmError](https://firebase.google.com/docs/reference/fcm/rest/v1/FcmError)
- [ErrorCode](https://firebase.google.com/docs/reference/fcm/rest/v1/ErrorCode)
- [ApnsError](https://firebase.google.com/docs/reference/fcm/rest/v1/ApnsError)
- [Handling Notification Responses from APNs](https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/handling_notification_responses_from_apns)

TODO: 具体的なエラーレスポンスの形式を後で確認して記載。

エラー原因によってレスポンスボディのerror.detailsに格納される内容が異なります。

- FCM起因の場合は、FcmError形式の応答（FCMのErrorCodeが返ってくる）
- Apns起因の場合は、ApnsError形式の応答（ApnsのStatusCodeとreason文字列が返ってくる）

#### 再送制御

FCMから以下のエラー応答が返ってきた場合には、通知送信の一時的な失敗とその理由をログに記録した上で、時間をおいた後にFCMへの通知送信をリトライします。

- FcmError
  - 429 QUOTA_EXCEEDED
  - 503 UNAVAILABLE
  - 500 INTERNAL
- ApnsError
  - 429 TooManyRequests
  - 500 InternalServerError
  - 503 ServiceUnavailable
  - 503 Shutdown

リトライするまでの待機時間は、以下のルールに従って決定します。

- レスポンスヘッダにRetry-Afterが含まれている場合は、そのヘッダで指定された秒数だけ待機
- レスポンスヘッダにRetry-Afterが含まれていない場合は指数バックオフに従い、1秒、2秒、4秒と指数関数的に時間を増やしながら待機

リトライ回数の上限は、サンプルアプリケーションでは3回とします。

リトライ回数の上限に達しても送信に成功しなかった場合には、通知送信の失敗とその理由をログに記録します。
その後の処理については、通知のユースケースごとにアプリケーションのエラーハンドリングとして別途検討します。

#### 無効な登録トークンの削除

FCMから以下のエラー応答が返ってきた場合には、通知送信の失敗とその理由をログに記録した上で、バックエンドサーバに保存されている当該登録トークンを削除します。
その後の処理については、通知のユースケースごとにアプリケーションのエラーハンドリングとして別途検討します。

- FcmError
  - 404 UNREGISTERED
- ApnsError
  - 410 Unregistered

#### その他のエラーへの対応

その他のエラー応答が返ってきた場合には、通知送信の失敗とその理由をログに記録します。
その後の処理については、通知のユースケースごとにアプリケーションのエラーハンドリングとして別途検討します。

### 運用上の注意点

#### APNs Auth Keyの管理

APNs Auth Keyを使った認証形式は、過去の証明書を用いた形式と異なり有効期限はなく、更新運用は不要です。
その代わり、APNs Auth KeyはApple Developer Programのアカウント全体で2つまでしか発行できず、
アプリ単位ではなくアカウント全体で共用されるものとなります。

2つまでしか発行できず、APNs Auth Keyの移行期間中に並行運用することなどを考えると
開発・本番環境で別の鍵を利用するのも難しいです。
鍵ファイルの管理には最新の注意を払いましょう。

## 決定

:::note
最終的な決定内容を記録してください
:::
